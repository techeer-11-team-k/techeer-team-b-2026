# 매매/전월세 매칭 로직 수정 및 개선

## 1차 수정: BRAND_ENG_TO_KOR 오류 해결 ✅

### 오류 원인
```
NameError: name 'BRAND_ENG_TO_KOR' is not defined
```

### 수정 내용
- `BRAND_ENG_TO_KOR` 클래스 속성 추가
- `self.BRAND_ENG_TO_KOR`로 참조 방식 수정

---

## 2차 분석: 매칭 실패 패턴 분석

### 실패 케이스 분석

| 아파트명 | 지번 | 건축년도 | 동 | 최고점수 | 문제점 |
|---------|------|---------|---|---------|-------|
| 홍우 | 47-14 | 1990 | 영동읍 부용리 | 0.00 | 이름이 너무 짧음 (2글자) |
| 신양 | 56 | 1991 | 영동읍 부용리 | 0.00 | 이름이 너무 짧음 (2글자) |
| 효정 | 30-89 | 1988 | 가좌동 | 0.00 | 이름이 너무 짧음 (2글자) |
| 태산 | 499 | 1989 | 석남동 | 0.00 | 이름이 너무 짧음 (2글자) |
| 인향 | 566 | 1989 | 가정동 | 0.00 | 이름이 너무 짧음 (2글자) |
| 교직원 | 18-2 | 1977 | 구암동 | 0.00 | 특수 명칭 (교직원아파트) |
| 크라운 | 1345 | 1984 | 구암동 | 0.22 | 임계값(0.30)에 근접 |
| 로데오맨션 | 313 | 1989 | 광영동 | 0.13 | "맨션" 구식 명칭 |
| 연화빌라 | 830-27 | 1994 | 양덕동 | 0.00 | "빌라" 명칭 포함 |
| 해피니스101동 | 179-13 | 2016 | 후포면 삼율리 | 0.00 | "101동"이 이름에 포함 |
| 한얼골든뷰 | 156-19 | 2004 | 양덕동 | 0.00 | DB에 없는 아파트 |
| 삼라마이다스 | 720-3 | 2007 | 대곡동 | 0.13 | 동 매칭 실패 |

### 문제점 분류

1. **짧은 이름 문제 (40%)**: 2~3글자 아파트명
2. **구식 명칭 문제 (20%)**: 맨션, 빌라 등
3. **동 번호 포함 문제 (10%)**: "101동" 등이 이름에 포함
4. **DB 미등록 문제 (20%)**: 아파트가 DB에 없음
5. **임계값 문제 (10%)**: 점수가 임계값에 근접

---

## 개선 방안

### 1. 짧은 이름 특별 처리
- 2~3글자 이름은 임계값을 더 낮춤 (0.15)
- 동 이름 + 짧은 이름 조합으로 매칭 시도

### 2. 구식 명칭 제거
- "맨션", "빌라", "아파트", "APT" 등 접미사 제거 후 매칭

### 3. 동 번호 제거
- "101동", "102동" 등을 이름에서 제거

### 4. 지번 기반 매칭 강화
- 지번이 일치하면 점수 대폭 상승 (현재도 있지만 강화)

### 5. 건축년도 기반 매칭
- 같은 동에서 건축년도가 ±2년 이내면 점수 상승

### 6. 후보 수에 따른 동적 임계값
```
후보 1개: 0.05 (거의 무조건 매칭)
후보 2개: 0.10
후보 3개: 0.15
후보 5개 이하: 0.20
후보 10개 이하: 0.25
그 외: 0.30
```

---

## 구현 완료 코드

### `_clean_apt_name` 개선 ✅

동 번호(101동 등)와 구식 명칭(맨션, 빌라 등)을 제거합니다.

```python
# 동 번호 제거 (예: "101동", "102동", "A동", "B동")
cleaned = re.sub(r'\d{2,3}동\s*$', '', cleaned)
cleaned = re.sub(r'[A-Za-z]동\s*$', '', cleaned)
cleaned = re.sub(r'\d{2,3}동(?=\s|$)', '', cleaned)

# 구식 명칭 제거 (끝에 붙은 경우만)
old_suffixes = ['맨션', '빌라', '아파트', 'APT', 'apt', '주택', '연립', '타운하우스']
for suffix in old_suffixes:
    if cleaned.lower().endswith(suffix.lower()):
        cleaned = cleaned[:-len(suffix)]
        break
```

### 임계값 동적 조정 ✅

후보 수와 이름 길이에 따라 임계값을 동적으로 조정합니다.

```python
# 후보 수에 따른 동적 임계값
threshold = 0.30  # 기본값
if len(candidates) == 1:
    threshold = 0.05  # 후보 1개면 거의 무조건 매칭
elif len(candidates) == 2:
    threshold = 0.10  # 후보 2개
elif len(candidates) <= 3:
    threshold = 0.15  # 후보 3개 이하
elif len(candidates) <= 5:
    threshold = 0.20  # 후보 5개 이하
elif len(candidates) <= 10:
    threshold = 0.25  # 후보 10개 이하

# 짧은 이름 (2~3글자)은 임계값 추가 낮춤
cleaned_name = self._clean_apt_name(apt_name_api)
if len(cleaned_name) <= 3:
    threshold = min(threshold, 0.10)
elif len(cleaned_name) <= 4:
    threshold = min(threshold, 0.15)
```

---

## 파일 변경 목록

- `backend/app/services/data_collection.py`
  - `BRAND_ENG_TO_KOR` 클래스 속성 추가 ✅
  - `self.BRAND_ENG_TO_KOR`로 참조 방식 수정 ✅
  - `_clean_apt_name` 개선 (구식 명칭, 동 번호 제거) ✅
  - `_match_apartment` 임계값 동적 조정 ✅
  - `_match_apartment_with_debug` 임계값 동적 조정 ✅
  - 지역 순회 진행 상황 로깅 추가 ✅

---

## 3차 개선: 지역 순회 진행 상황 로깅

### 문제점
- 기존 로그에서 현재 몇 개 지역을 순회 중인지 알 수 없었음
- 모든 시군구가 순회되는지 확인하기 어려웠음

### 개선 내용

#### 1. 월별 시작/완료 로그 추가

```
📆 [1/12] 2020년 1월 시작: 228개 지역 순회
✅ [1/12] 2020년 1월 완료: 228/228개 지역 처리됨
```

#### 2. 각 지역별 로그에 진행 상황 표시

```
[45/228] 43740/202001 (2020년 1월): ✅13 ⏭️0 ❌6 (신양)
[46/228] 28260/202001 (2020년 1월): ✅0 ⏭️0 ❌3 (효정)
```

### 로그 형식 변경 요약

| 기존 | 변경 후 |
|-----|--------|
| `43740/202001 (2020년 1월): ✅13 ⏭️0 ❌6` | `[45/228] 43740/202001 (2020년 1월): ✅13 ⏭️0 ❌6` |

#### 3. 병렬 처리 완료 확인
- 각 월 완료 시 `완료: {completed}/{total}개 지역 처리됨` 로그로 모든 지역이 처리되었는지 확인 가능

#### 4. 지역별 처리 시작 로그 추가
- 각 지역 처리를 시작할 때마다 로그 출력
- 예: `🔄 [45/228] 43740/202001 (2020년 1월) 처리 시작...`

---

## 4차 분석: 추가 실패 패턴 분석

### 실패 케이스 재분석

| 아파트명 | 동 | 상위후보 | 최고점수 | 분석 |
|---------|---|---------|---------|-----|
| 이스트드림힐 | 길동 | 명일삼익그린11차 | 0.00 | DB에 없는 아파트 |
| 삼화 | 신천동 | 대구연경아이파크 | 0.00 | 짧은 이름(2글자), DB에 없음 |
| 대명 | 연무동 | 북수원I-PARK | 0.00 | 짧은 이름(2글자), DB에 없음 |
| 영풍마드레빌 | 성내동 | 명일삼익그린11차 | 0.00 | DB에 없는 아파트 |
| 성내스테이 | 성내동 | 명일삼익그린11차 | 0.00 | DB에 없는 아파트 |
| 제일풍경채에듀앤파크 | 장지동 | 진안동월드메르디앙 | 0.00 | DB에 없는 아파트 |
| 거승수정빌라트 | 부암동 | 양정한진스카이뷰 | 0.13 | DB에 없는 아파트 |

### 결론

대부분의 실패 케이스는 **아파트 테이블에 해당 아파트가 없는 경우**입니다.
이는 정상적인 매칭 실패이며, 잘못된 아파트에 거래가 들어가는 것을 방지합니다.

### 개선 사항

1. **상위 후보 표시 개선**: 점수순으로 정렬하여 상위 3개 표시 (기존: 순서대로 3개)
2. **실패 로그 주석 처리**: 지역 순회 확인을 위해 개별 실패 로그 비활성화
3. **실패 샘플 CSV 저장**: `db_backup/fail.csv`에 실패 정보 저장 (분석용)

### 안전장치

- **임계값 유지**: 점수가 임계값 미만이면 절대 매칭하지 않음
- **잘못된 매칭 방지**: DB에 없는 아파트는 매칭 실패로 처리됨

---

## 예상 효과

| 케이스 | 이전 | 이후 |
|-------|-----|-----|
| 후보 1개 + 짧은 이름 | 임계값 0.10 | 임계값 0.05 |
| 후보 2개 + 짧은 이름 | 임계값 0.20 | 임계값 0.10 |
| "해피니스101동" | 동 번호 포함 | "해피니스"로 정리됨 |
| "로데오맨션" | "맨션" 포함 | "로데오"로 정리됨 |
| "연화빌라" | "빌라" 포함 | "연화"로 정리됨 |

---

## 적용 방법

```bash
docker-compose restart backend
```

---

## 남은 한계

1. **DB 미등록**: DB에 없는 아파트는 매칭 불가
2. **완전히 다른 이름**: 재건축 등으로 이름이 완전히 바뀐 경우
3. **동 매칭 실패**: 행정동 변경 등으로 동 이름이 바뀐 경우

이런 경우는 별도의 이름 매핑 테이블이나 지번 기반 매칭 강화가 필요합니다.
