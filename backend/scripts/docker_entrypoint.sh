#!/bin/bash
# ============================================================
# Docker ?酉?껆뵳?猷?紐낅뱜 ??쎄쾿?깆???# 1. ?怨쀬뵠?怨뺤퓢??곷뮞 ?怨뚭퍙 ??疫?
# 2. ?癒?짗 筌띾뜆?졿뉩紐껋쟿??곷???쎈뻬
# 3. FastAPI ??뺤쒔 ??뽰삂
# ============================================================

echo "?? Docker ?酉?껆뵳?猷?紐낅뱜 ??뽰삂..."

# --------------------------------------------------------
# 1. ?怨쀬뵠?怨뺤퓢??곷뮞 ?怨뚭퍙 ??疫?
# --------------------------------------------------------
echo "???怨쀬뵠?怨뺤퓢??곷뮞 ?怨뚭퍙 ??疫?餓?.."

# DATABASE_URL?癒?퐣 ?紐꾨뮞?紐? ?????곕뗄??DB_HOST=$(echo "$DATABASE_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
DB_PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')

if [ -z "$DB_HOST" ]; then
    DB_HOST="db"
fi

if [ -z "$DB_PORT" ]; then
    DB_PORT="5432"
fi

echo "?諭??怨쀬뵠?怨뺤퓢??곷뮞: $DB_HOST:$DB_PORT"

# Python ??쎄쾿?깆??껅에?DB ?怨뚭퍙 ??疫?(筌ㅼ뮆? 60??
if python /app/scripts/wait_for_db.py "$DB_HOST" "$DB_PORT" 60; then
    # ?곕떽? ??疫?(DB揶쎛 ?袁⑹읈??餓Β??쑬留????돱筌왖)
    echo "???怨쀬뵠?怨뺤퓢??곷뮞 ?λ뜃由????疫?(3??..."
    sleep 3
else
    echo "?醫묓닔  ?怨쀬뵠?怨뺤퓢??곷뮞 ?怨뚭퍙 ??쎈솭, 筌띾뜆?졿뉩紐껋쟿??곷?椰꾨?瑗??"
    echo "?? FastAPI ??뺤쒔 ??뽰삂..."
    exec "$@"
fi

# --------------------------------------------------------
# 2. ?癒?짗 筌띾뜆?졿뉩紐껋쟿??곷???쎈뻬
# --------------------------------------------------------
echo ""
echo "?遊??癒?짗 筌띾뜆?졿뉩紐껋쟿??곷???쎈뻬 餓?.."

if python /app/scripts/auto_migrate.py; then
    echo "??筌띾뜆?졿뉩紐껋쟿??곷??袁⑥┷!"
else
    echo "?醫묓닔  筌띾뜆?졿뉩紐껋쟿??곷?野껋럡??(??뺤쒔???④쑴????뽰삂??몃빍??"
fi

# --------------------------------------------------------
# 3. FastAPI ??뺤쒔 ??뽰삂
# --------------------------------------------------------
echo ""
echo "?? FastAPI ??뺤쒔 ??뽰삂..."
echo "=================================================="

# ?袁⑤뼎獄쏆룇? 筌뤿굝議????쎈뻬 (疫꿸퀡?? uvicorn)
exec "$@"
