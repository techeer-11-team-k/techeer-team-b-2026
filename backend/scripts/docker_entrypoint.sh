#!/bin/bash
# ============================================================
# Docker 엔트리포인트 스크립트 시작
# 1. 데이터베이스 연결 대기
# 2. 자동 마이그레이션 실행
# 3. FastAPI 서버 시작
# ============================================================

echo "🚀 Docker 엔트리포인트 스크립트 시작..."

# --------------------------------------------------------
# 1. 데이터베이스 연결 대기
# --------------------------------------------------------
echo "⏳ 데이터베이스 연결 대기 중..."

# DATABASE_URL에서 정보 추출 (없으면 기본값 사용)
# DB_HOST=$(echo "$DATABASE_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
DB_PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')

if [ -z "$DB_HOST" ]; then
    DB_HOST="db"
fi

if [ -z "$DB_PORT" ]; then
    DB_PORT="5432"
fi

echo "🎯 타겟 데이터베이스: $DB_HOST:$DB_PORT"

# Python 스크립트로 DB 연결 대기 (최대 60초)
if python /app/scripts/wait_for_db.py "$DB_HOST" "$DB_PORT" 60; then
    # 연결 성공 (DB가 준비될 때까지 잠시 대기)
    echo "✅ 데이터베이스 연결 성공! (3초 대기...)"
    sleep 3
else
    echo "❌ 데이터베이스 연결 실패. 마이그레이션을 건너뜁니다."
    echo "⚠️ FastAPI 서버를 시작합니다..."
    exec "$@"
fi

# --------------------------------------------------------
# 2. 자동 마이그레이션 실행
# --------------------------------------------------------
echo ""
echo "📦 자동 마이그레이션 실행 중..."

if python /app/scripts/auto_migrate.py; then
    echo "✅ 마이그레이션 완료!"
else
    echo "❌ 마이그레이션 실패 (서버는 계속 실행됩니다)"
fi

# --------------------------------------------------------
# 3. FastAPI 서버 시작
# --------------------------------------------------------
echo ""
echo "🚀 FastAPI 서버 시작..."
echo "=================================================="

# 전달받은 명령어 실행 (기본값 uvicorn)
exec "$@"