# 데이터 수집 서비스 모듈 구조

## 개요

`data_collection.py` 파일이 너무 커서 기능별로 모듈화했습니다.

## 모듈 구조

```
data_collection/
├── __init__.py              # 메인 서비스 클래스 export
├── base.py                  # 기본 클래스 (공통 메서드)
├── constants.py             # 상수 정의
├── state_collection/        # 지역 데이터 수집
├── apt_collection/          # 아파트 목록 수집
├── apt_detail_collection/   # 아파트 상세 정보 수집
├── sale_collection/         # 매매 실거래가 수집
├── rent_collection/         # 전월세 실거래가 수집
└── house_score_collection/  # 부동산 지수 수집
```

## 매매 수집 로직 개선

### 변경 사항

1. **최우선 매칭: 시군구+동코드(10자리)+지번**
   - 아파트 이름이 다르더라도, 시군구+동코드 일치하고 지번이 일치하면 같은 아파트로 인식
   - 본번-부번 정확 매칭 시도

2. **매칭 우선순위**
   1. 시군구+동코드(10자리)+지번 매칭 (최우선)
   2. 시군구+동코드(10자리) 매칭
   3. 시군구 코드만 매칭
   4. 동 이름 매칭
   5. 이름 매칭 (보조)

### 새로운 API 활용

- `umdCd`: 읍면동코드 (10자리 지역코드 구성)
- `bonbun`/`bubun`: 본번/부번 (정확한 지번 매칭)
- `aptSeq`: 단지 일련번호 (중복 체크 및 추적)

## 기대 효과

1. **매칭 정확도 향상**
   - 시군구+동코드+지번 매칭으로 이름이 달라도 정확히 매칭 가능
   - 본번-부번 정확 매칭으로 지번 기반 매칭 정확도 향상

2. **매칭 실패율 감소**
   - 이름 매칭 실패 시에도 지번 기반 매칭으로 보완
   - 동일 아파트의 다양한 이름 표기 처리 가능

3. **데이터 품질 향상**
   - 더 정확한 필드(bonbun, bubun, umdCd) 활용
   - 단지 일련번호(aptSeq)로 중복 체크 강화

## 한계

1. **지번 데이터 부족**
   - DB에 지번 정보가 없는 아파트는 이름 매칭에 의존
   - 지번 형식이 일치하지 않는 경우 매칭 실패 가능

2. **동코드 매핑 오류**
   - API의 동코드와 DB의 동코드가 일치하지 않는 경우 매칭 실패
   - 동 이름 기반 매칭으로 보완하지만 완벽하지 않음

3. **이름 매칭의 한계**
   - 이름이 완전히 다른 경우 여전히 매칭 실패 가능
   - 브랜드명, 단지번호 등으로 보완하지만 한계 존재

## 사용 방법

```python
from app.services.data_collection import data_collection_service

# 매매 데이터 수집
result = await data_collection_service.collect_sales_data(
    db=db,
    start_ym="202401",
    end_ym="202412"
)
```
