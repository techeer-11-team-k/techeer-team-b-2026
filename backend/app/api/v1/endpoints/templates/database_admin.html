<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—„ï¸ DB ê´€ë¦¬ ì„¼í„°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { font-size: 0.875rem; padding: 10px; background: #f8f9fa; }
        .container-fluid { max-width: 1800px; }
        .card { margin-bottom: 10px; }
        .card-header { padding: 8px 12px; font-size: 0.9rem; font-weight: 600; }
        .card-body { padding: 12px; }
        .table-sm { font-size: 0.8rem; }
        .table-sm th, .table-sm td { padding: 4px 8px; white-space: nowrap; }
        .badge { font-size: 0.7rem; }
        .form-control-sm, .form-select-sm, .btn-sm { font-size: 0.8rem; padding: 4px 8px; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .table-sticky thead th { position: sticky; top: 0; background: #0d6efd; color: white; z-index: 10; }
        .apart-list-item { cursor: pointer; padding: 6px; border-left: 3px solid transparent; }
        .apart-list-item:hover { background: #e7f3ff; border-left-color: #0d6efd; }
        .apart-list-item.active { background: #cfe2ff; border-left-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-12">
                <h4 class="mb-0">ğŸ—„ï¸ DB ê´€ë¦¬ ì„¼í„°</h4>
                <small class="text-muted">ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì¡°íšŒ, ê²€ìƒ‰, ë°±ì—… ë° ë³µì›</small>
            </div>
        </div>

        <div class="row g-2">
            <!-- ì™¼ìª½: í…Œì´ë¸” ëª©ë¡ -->
            <div class="col-md-2">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-list-ul"></i> í…Œì´ë¸” ëª©ë¡
                        <button class="btn btn-sm btn-light float-end" onclick="loadStats()" title="DB í†µê³„">
                            <i class="bi bi-bar-chart"></i>
                        </button>
                    </div>
                    <div class="card-body p-2">
                        <input type="text" id="tableSearch" class="form-control form-control-sm mb-2" placeholder="ê²€ìƒ‰..." oninput="filterTables()">
                        <div id="tableList" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">ë¡œë”© ì¤‘...</div>
                        </div>
                        <hr class="my-1">
                        <button class="btn btn-sm btn-info w-100 mb-1" onclick="loadTableInfo()">
                            <i class="bi bi-info-circle"></i> í…Œì´ë¸” ì •ë³´
                        </button>
                        <button class="btn btn-sm btn-warning w-100 mb-1" onclick="loadTableIndexes()">
                            <i class="bi bi-list-check"></i> ì¸ë±ìŠ¤
                        </button>
                        <button class="btn btn-sm btn-secondary w-100 mb-1" onclick="loadTableConstraints()">
                            <i class="bi bi-link-45deg"></i> ì œì•½ì¡°ê±´
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì¤‘ì•™: ë°ì´í„° ì¡°íšŒ -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-table"></i> ë°ì´í„° ì¡°íšŒ
                        <span id="tableInfo" class="badge bg-light text-dark ms-2"></span>
                    </div>
                    <div class="card-body p-2">
                        <div class="row g-2 mb-2">
                            <div class="col-md-3">
                                <select id="tableSelect" class="form-select form-select-sm">
                                    <option value="">í…Œì´ë¸” ì„ íƒ</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" id="limitInput" class="form-control form-control-sm" value="100" min="1" max="50000" placeholder="Limit">
                            </div>
                            <div class="col-md-2">
                                <input type="number" id="offsetInput" class="form-control form-control-sm" value="0" min="0" placeholder="Offset">
                            </div>
                            <div class="col-md-3">
                                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="ê²€ìƒ‰ì–´...">
                            </div>
                            <div class="col-md-2">
                                <select id="orderDirection" class="form-select form-select-sm">
                                    <option value="ASC">ì˜¤ë¦„ì°¨ìˆœ</option>
                                    <option value="DESC">ë‚´ë¦¼ì°¨ìˆœ</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-md-10">
                                <select id="orderByColumn" class="form-select form-select-sm">
                                    <option value="">ì •ë ¬ ì»¬ëŸ¼ (ê¸°ë³¸: PK)</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-sm w-100" onclick="loadTableData()">
                                    <i class="bi bi-search"></i> ì¡°íšŒ
                                </button>
                            </div>
                        </div>
                        <div id="dataResult"></div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì•„íŒŒíŠ¸ ê²€ìƒ‰ ë° ìƒì„¸ ì •ë³´ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-house-door"></i> ì•„íŒŒíŠ¸ ê²€ìƒ‰
                    </div>
                    <div class="card-body p-2">
                        <input type="text" id="apartSearch" class="form-control form-control-sm mb-2" placeholder="ì•„íŒŒíŠ¸ëª… ê²€ìƒ‰..." oninput="searchApartments()">
                        <div id="apartList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="card mt-2">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-info-circle"></i> ìƒì„¸ ì •ë³´
                    </div>
                    <div class="card-body p-2">
                        <div id="apartDetail"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í†µí•© ì¡°íšŒ íƒ­ -->
        <div class="row mt-2">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-grid-3x3-gap"></i> í†µí•© ì¡°íšŒ (ì•„íŒŒíŠ¸ Â· ì§€ì—­ Â· ë§¤ë§¤)
                    </div>
                    <div class="card-body p-2">
                        <ul class="nav nav-tabs nav-tabs-sm mb-2" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="apart-tab" data-bs-toggle="tab" data-bs-target="#apart-pane" type="button" role="tab">
                                    <i class="bi bi-house-door"></i> ì•„íŒŒíŠ¸
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="region-tab" data-bs-toggle="tab" data-bs-target="#region-pane" type="button" role="tab">
                                    <i class="bi bi-geo-alt"></i> ì§€ì—­
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sale-tab" data-bs-toggle="tab" data-bs-target="#sale-pane" type="button" role="tab">
                                    <i class="bi bi-cash-coin"></i> ë§¤ë§¤ ê±°ë˜
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <!-- ì•„íŒŒíŠ¸ íƒ­ -->
                            <div class="tab-pane fade show active" id="apart-pane" role="tabpanel">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-4">
                                        <input type="text" id="integratedApartSearch" class="form-control form-control-sm" placeholder="ì•„íŒŒíŠ¸ëª… ê²€ìƒ‰..." oninput="searchIntegratedApartments()">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="apartLimit" class="form-control form-control-sm" value="50" min="1" max="500" placeholder="Limit">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="apartOffset" class="form-control form-control-sm" value="0" min="0" placeholder="Offset">
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-success btn-sm w-100" onclick="loadIntegratedApartments()">
                                            <i class="bi bi-search"></i> ì¡°íšŒ
                                        </button>
                                    </div>
                                </div>
                                <div id="integratedApartResult"></div>
                            </div>
                            <!-- ì§€ì—­ íƒ­ -->
                            <div class="tab-pane fade" id="region-pane" role="tabpanel">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-4">
                                        <input type="text" id="regionSearch" class="form-control form-control-sm" placeholder="ì§€ì—­ëª… ê²€ìƒ‰ (ì‹œ/êµ°/êµ¬)..." oninput="searchRegions()">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="regionLimit" class="form-control form-control-sm" value="50" min="1" max="500" placeholder="Limit">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="regionOffset" class="form-control form-control-sm" value="0" min="0" placeholder="Offset">
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-info btn-sm w-100" onclick="loadRegions()">
                                            <i class="bi bi-search"></i> ì¡°íšŒ
                                        </button>
                                    </div>
                                </div>
                                <div id="integratedRegionResult"></div>
                            </div>
                            <!-- ë§¤ë§¤ ê±°ë˜ íƒ­ -->
                            <div class="tab-pane fade" id="sale-pane" role="tabpanel">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-3">
                                        <input type="number" id="saleAptId" class="form-control form-control-sm" placeholder="ì•„íŒŒíŠ¸ ID (ì„ íƒ)">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="saleLimit" class="form-control form-control-sm" value="100" min="1" max="1000" placeholder="Limit">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="saleOffset" class="form-control form-control-sm" value="0" min="0" placeholder="Offset">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" id="saleSearch" class="form-control form-control-sm" placeholder="ê²€ìƒ‰ì–´...">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-warning btn-sm w-100" onclick="loadSales()">
                                            <i class="bi bi-search"></i> ì¡°íšŒ
                                        </button>
                                    </div>
                                </div>
                                <div id="integratedSaleResult"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨: ë°±ì—…/ë³µì› ë° ê´€ë¦¬ ê¸°ëŠ¥ -->
        <div class="row mt-2">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-database"></i> ë°±ì—… ë° ë³µì›
                    </div>
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <select id="backupTableSelect" class="form-select form-select-sm">
                                    <option value="">ì „ì²´ ë°±ì—…</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="backupAction" class="form-select form-select-sm">
                                    <option value="backup">ë°±ì—…</option>
                                    <option value="restore">ë³µì›</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-secondary btn-sm w-100" onclick="backupRestore()">
                                    <i class="bi bi-play-fill"></i> ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                        <div class="mt-2" id="backupResult"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-exclamation-triangle"></i> ìœ„í—˜í•œ ì‘ì—…
                    </div>
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-8">
                                <select id="dangerTableSelect" class="form-select form-select-sm">
                                    <option value="">í…Œì´ë¸” ì„ íƒ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning btn-sm w-100 mb-1" onclick="truncateTable()">
                                    <i class="bi bi-trash"></i> ë°ì´í„° ì‚­ì œ
                                </button>
                                <button class="btn btn-danger btn-sm w-100" onclick="dropTable()">
                                    <i class="bi bi-x-circle"></i> í…Œì´ë¸” ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="mt-2" id="dangerResult"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ëª¨ë‹¬: í…Œì´ë¸” ì •ë³´ -->
        <div class="modal fade" id="tableInfoModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">í…Œì´ë¸” ì •ë³´</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="tableInfoContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api/v1/admin';
        const SEARCH_API = '/api/v1/search';
        const APARTMENTS_API = '/api/v1/apartments';
        let allTables = [];
        let searchTimeout = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.onload = async () => {
            await loadTables();
        };

        // í…Œì´ë¸” ëª©ë¡ ë¡œë“œ
        async function loadTables() {
            try {
                const response = await fetch(`${API_BASE}/db/tables`);
                const result = await response.json();
                if (result.success) {
                    allTables = result.data.tables;
                    renderTables(allTables);
                    updateSelects(allTables);
                }
            } catch (error) {
                document.getElementById('tableList').innerHTML = 
                    `<div class="alert alert-danger alert-sm py-1">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // í…Œì´ë¸” ëª©ë¡ ë Œë”ë§
        function renderTables(tables) {
            const container = document.getElementById('tableList');
            if (tables.length === 0) {
                container.innerHTML = '<div class="text-muted text-center">í…Œì´ë¸” ì—†ìŒ</div>';
                return;
            }
            container.innerHTML = tables.map(table => 
                `<div class="apart-list-item" onclick="selectTable('${table}')">${table}</div>`
            ).join('');
        }

        // í…Œì´ë¸” ì„ íƒ
        function selectTable(tableName) {
            document.getElementById('tableSelect').value = tableName;
            document.getElementById('backupTableSelect').value = tableName;
            if (document.getElementById('dangerTableSelect')) {
                document.getElementById('dangerTableSelect').value = tableName;
            }
            document.querySelectorAll('.apart-list-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent === tableName) item.classList.add('active');
            });
            updateOrderByColumn(tableName);
            loadTableData();
        }

        // ì •ë ¬ ì»¬ëŸ¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        async function updateOrderByColumn(tableName) {
            if (!tableName) return;
            try {
                const response = await fetch(`${API_BASE}/db/table/info?table_name=${encodeURIComponent(tableName)}`);
                const result = await response.json();
                if (result.success) {
                    const orderSelect = document.getElementById('orderByColumn');
                    orderSelect.innerHTML = '<option value="">ì •ë ¬ ì»¬ëŸ¼ (ê¸°ë³¸: PK)</option>';
                    result.data.columns.forEach(col => {
                        const option = document.createElement('option');
                        option.value = col.name;
                        option.textContent = `${col.name} (${col.type})`;
                        orderSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ì»¬ëŸ¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // í…Œì´ë¸” í•„í„°ë§
        function filterTables() {
            const search = document.getElementById('tableSearch').value.toLowerCase();
            const filtered = allTables.filter(t => t.toLowerCase().includes(search));
            renderTables(filtered);
        }

        // Select ì—…ë°ì´íŠ¸
        function updateSelects(tables) {
            ['tableSelect', 'backupTableSelect', 'dangerTableSelect'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = selectId === 'backupTableSelect' 
                    ? '<option value="">ì „ì²´ ë°±ì—…</option>' 
                    : selectId === 'dangerTableSelect'
                    ? '<option value="">í…Œì´ë¸” ì„ íƒ</option>'
                    : '<option value="">í…Œì´ë¸” ì„ íƒ</option>';
                tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    select.appendChild(option);
                });
                if (currentValue) select.value = currentValue;
            });
        }

        // í…Œì´ë¸” ë°ì´í„° ë¡œë“œ
        async function loadTableData() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                document.getElementById('dataResult').innerHTML = 
                    '<div class="alert alert-info py-2">í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”</div>';
                document.getElementById('tableInfo').textContent = '';
                return;
            }

            const limit = parseInt(document.getElementById('limitInput').value) || 100;
            const offset = parseInt(document.getElementById('offsetInput').value) || 0;
            const search = document.getElementById('searchInput').value;
            const orderBy = document.getElementById('orderByColumn').value;
            const orderDirection = document.getElementById('orderDirection').value;

            document.getElementById('dataResult').innerHTML = '<div class="text-center text-muted">ë¡œë”© ì¤‘...</div>';

            try {
                let url = `${API_BASE}/db/query?table_name=${encodeURIComponent(tableName)}&limit=${limit}&offset=${offset}&order_direction=${orderDirection}`;
                if (orderBy) {
                    url += `&order_by=${encodeURIComponent(orderBy)}`;
                }
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    renderTableData(result.data, search);
                } else {
                    document.getElementById('dataResult').innerHTML = 
                        `<div class="alert alert-danger py-2">ì˜¤ë¥˜: ${result.detail?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>`;
                }
            } catch (error) {
                document.getElementById('dataResult').innerHTML = 
                    `<div class="alert alert-danger py-2">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // í…Œì´ë¸” ë°ì´í„° ë Œë”ë§
        function renderTableData(data, search) {
            const columnCount = data.columns.length;
            const orderInfo = data.order_by ? ` | ì •ë ¬: ${data.order_by} ${data.order_direction}` : '';
            const pkInfo = data.pk_column ? ` | PK: ${data.pk_column}` : '';
            document.getElementById('tableInfo').textContent = `ì»¬ëŸ¼: ${columnCount}ê°œ | ì „ì²´: ${data.total}ê°œ${pkInfo}${orderInfo}`;
            
            let html = `<div class="alert alert-info py-1 mb-2">
                ì „ì²´: ${data.total.toLocaleString()}ê°œ | ì¡°íšŒ: ${data.rows.length}ê°œ | ì»¬ëŸ¼: ${columnCount}ê°œ
                ${data.pk_column ? ` | PK: <strong>${escapeHtml(data.pk_column)}</strong>` : ''}
                ${data.order_by ? ` | ì •ë ¬: <strong>${escapeHtml(data.order_by)} ${data.order_direction}</strong>` : ''}
            </div>`;
            
            if (data.rows.length === 0) {
                html += '<div class="alert alert-warning py-2">ë°ì´í„° ì—†ìŒ</div>';
                document.getElementById('dataResult').innerHTML = html;
                return;
            }

            let filteredRows = data.rows;
            if (search) {
                const searchLower = search.toLowerCase();
                filteredRows = data.rows.filter(row => 
                    Object.values(row).some(val => String(val).toLowerCase().includes(searchLower))
                );
            }

            html += '<div class="table-responsive"><table class="table table-sm table-striped table-hover table-sticky">';
            html += '<thead><tr>';
            data.columns.forEach(col => {
                const isPk = col === data.pk_column;
                const isOrderBy = col === data.order_by;
                const pkBadge = isPk ? ' <span class="badge bg-primary">PK</span>' : '';
                const sortIcon = isOrderBy ? (data.order_direction === 'ASC' ? ' <i class="bi bi-sort-up"></i>' : ' <i class="bi bi-sort-down"></i>') : '';
                html += `<th style="cursor: pointer;" onclick="sortByColumn('${escapeHtml(col)}')" title="í´ë¦­í•˜ì—¬ ì •ë ¬">${escapeHtml(col)}${pkBadge}${sortIcon}</th>`;
            });
            html += '</tr></thead><tbody>';

            filteredRows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const value = row[col];
                    const isPk = col === data.pk_column;
                    const cellClass = isPk ? ' class="fw-bold text-primary"' : '';
                    html += `<td${cellClass}>${value !== null && value !== undefined ? escapeHtml(String(value)).substring(0, 50) : '<em class="text-muted">NULL</em>'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            document.getElementById('dataResult').innerHTML = html;
        }

        // ì»¬ëŸ¼ í´ë¦­í•˜ì—¬ ì •ë ¬
        function sortByColumn(columnName) {
            const orderSelect = document.getElementById('orderByColumn');
            const orderDirection = document.getElementById('orderDirection');
            
            // í˜„ì¬ ì •ë ¬ ìƒíƒœ í™•ì¸
            if (orderSelect.value === columnName) {
                // ê°™ì€ ì»¬ëŸ¼ì´ë©´ ë°©í–¥ ì „í™˜
                orderDirection.value = orderDirection.value === 'ASC' ? 'DESC' : 'ASC';
            } else {
                // ë‹¤ë¥¸ ì»¬ëŸ¼ì´ë©´ ì„ íƒí•˜ê³  ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì„¤ì •
                orderSelect.value = columnName;
                orderDirection.value = 'ASC';
            }
            
            loadTableData();
        }

        // ì•„íŒŒíŠ¸ ê²€ìƒ‰
        async function searchApartments() {
            const query = document.getElementById('apartSearch').value.trim();
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                document.getElementById('apartList').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${SEARCH_API}/apartments?q=${encodeURIComponent(query)}&limit=20`);
                    const result = await response.json();
                    
                    if (result.success && result.data.results.length > 0) {
                        renderApartList(result.data.results);
                    } else {
                        document.getElementById('apartList').innerHTML = 
                            '<div class="text-muted text-center small">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
                    }
                } catch (error) {
                    document.getElementById('apartList').innerHTML = 
                        `<div class="alert alert-danger py-1">ì˜¤ë¥˜: ${error.message}</div>`;
                }
            }, 300);
        }

        // ì•„íŒŒíŠ¸ ëª©ë¡ ë Œë”ë§
        function renderApartList(apartments) {
            const container = document.getElementById('apartList');
            container.innerHTML = apartments.map(apt => 
                `<div class="apart-list-item" onclick="loadApartDetail(${apt.apt_id})">
                    <strong>${escapeHtml(apt.apt_name)}</strong><br>
                    <small class="text-muted">${escapeHtml(apt.address || apt.sigungu_name)}</small>
                </div>`
            ).join('');
        }

        // ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadApartDetail(aptId) {
            document.getElementById('apartDetail').innerHTML = '<div class="text-center text-muted">ë¡œë”© ì¤‘...</div>';
            
            try {
                // ìƒì„¸ ì •ë³´ ì¡°íšŒ
                const detailResponse = await fetch(`${APARTMENTS_API}/${aptId}`);
                const detailResult = await detailResponse.json();
                
                // ê±°ë˜ ë‚´ì—­ ì¡°íšŒ (sales, rents í…Œì´ë¸”)
                const [salesResponse, rentsResponse] = await Promise.all([
                    fetch(`${API_BASE}/db/query?table_name=sales&limit=50&offset=0`).then(r => r.json()).catch(() => ({success: false})),
                    fetch(`${API_BASE}/db/query?table_name=rents&limit=50&offset=0`).then(r => r.json()).catch(() => ({success: false}))
                ]);

                let html = '';
                
                if (detailResult.apt_id) {
                    html += `<h6 class="mb-2">${escapeHtml(detailResult.road_address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ')}</h6>`;
                    html += `<div class="small mb-2">`;
                    html += `<div><strong>ì´ ì„¸ëŒ€ìˆ˜:</strong> ${detailResult.total_household_cnt || 'N/A'}ì„¸ëŒ€</div>`;
                    html += `<div><strong>ì´ ë™ìˆ˜:</strong> ${detailResult.total_building_cnt || 'N/A'}ë™</div>`;
                    html += `<div><strong>ìµœê³ ì¸µ:</strong> ${detailResult.highest_floor || 'N/A'}ì¸µ</div>`;
                    html += `<div><strong>ì£¼ì°¨ëŒ€ìˆ˜:</strong> ${detailResult.total_parking_cnt || 'N/A'}ëŒ€</div>`;
                    html += `</div>`;
                } else {
                    html += '<div class="alert alert-warning py-1">ìƒì„¸ ì •ë³´ ì—†ìŒ</div>';
                }

                // ê±°ë˜ ë‚´ì—­ í‘œì‹œ
                html += '<hr class="my-2">';
                html += '<h6 class="mb-1">ê±°ë˜ ë‚´ì—­</h6>';
                
                // ë§¤ë§¤ ê±°ë˜
                if (salesResponse.success) {
                    const sales = salesResponse.data.rows.filter(s => s.apt_id === aptId);
                    if (sales.length > 0) {
                        html += `<div class="small mb-1"><strong>ë§¤ë§¤:</strong> ${sales.length}ê±´</div>`;
                        html += '<div class="table-responsive" style="max-height: 150px;"><table class="table table-sm table-bordered mb-2">';
                        html += '<thead><tr><th>ê°€ê²©</th><th>ë©´ì </th><th>ì¸µ</th><th>ê³„ì•½ì¼</th></tr></thead><tbody>';
                        sales.slice(0, 5).forEach(sale => {
                            html += `<tr><td>${(sale.trans_price || 0).toLocaleString()}ë§Œì›</td><td>${sale.exclusive_area || 'N/A'}ã¡</td><td>${sale.floor || 'N/A'}ì¸µ</td><td>${sale.contract_date || 'N/A'}</td></tr>`;
                        });
                        html += '</tbody></table></div>';
                    }
                }

                // ì „ì›”ì„¸ ê±°ë˜
                if (rentsResponse.success) {
                    const rents = rentsResponse.data.rows.filter(r => r.apt_id === aptId);
                    if (rents.length > 0) {
                        html += `<div class="small mb-1"><strong>ì „ì›”ì„¸:</strong> ${rents.length}ê±´</div>`;
                        html += '<div class="table-responsive" style="max-height: 150px;"><table class="table table-sm table-bordered">';
                        html += '<thead><tr><th>ë³´ì¦ê¸ˆ</th><th>ì›”ì„¸</th><th>ë©´ì </th><th>ê³„ì•½ì¼</th></tr></thead><tbody>';
                        rents.slice(0, 5).forEach(rent => {
                            html += `<tr><td>${(rent.deposit_price || 0).toLocaleString()}ë§Œì›</td><td>${(rent.monthly_rent || 0).toLocaleString()}ë§Œì›</td><td>${rent.exclusive_area || 'N/A'}ã¡</td><td>${rent.contract_date || rent.deal_date || 'N/A'}</td></tr>`;
                        });
                        html += '</tbody></table></div>';
                    }
                }

                if (!salesResponse.success && !rentsResponse.success) {
                    html += '<div class="text-muted small">ê±°ë˜ ë‚´ì—­ ì¡°íšŒ ë¶ˆê°€</div>';
                }

                document.getElementById('apartDetail').innerHTML = html;
                
                // ì„ íƒ í‘œì‹œ
                document.querySelectorAll('#apartList .apart-list-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.onclick.toString().includes(aptId)) item.classList.add('active');
                });
            } catch (error) {
                document.getElementById('apartDetail').innerHTML = 
                    `<div class="alert alert-danger py-1">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ë°±ì—…/ë³µì›
        async function backupRestore() {
            const action = document.getElementById('backupAction').value;
            const tableName = document.getElementById('backupTableSelect').value;
            
            document.getElementById('backupResult').innerHTML = '<span class="text-muted">ì²˜ë¦¬ ì¤‘...</span>';

            try {
                const url = tableName 
                    ? `${API_BASE}/db/${action}?table_name=${tableName}`
                    : `${API_BASE}/db/${action}`;
                
                const response = await fetch(url, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('backupResult').innerHTML = 
                        `<span class="badge bg-success">âœ… ${result.data.message || 'ì„±ê³µ'}</span>`;
                } else {
                    document.getElementById('backupResult').innerHTML = 
                        `<span class="badge bg-danger">âŒ ${result.detail?.message || 'ì˜¤ë¥˜'}</span>`;
                }
            } catch (error) {
                document.getElementById('backupResult').innerHTML = 
                    `<span class="badge bg-danger">âŒ ${error.message}</span>`;
            }
        }

        // í…Œì´ë¸” ì •ë³´ ì¡°íšŒ
        async function loadTableInfo() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/db/table/info?table_name=${encodeURIComponent(tableName)}`);
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = `<h6>${escapeHtml(data.table_name)}</h6>`;
                    html += `<p><strong>í–‰ ìˆ˜:</strong> ${data.row_count.toLocaleString()}ê°œ | <strong>ì»¬ëŸ¼ ìˆ˜:</strong> ${data.column_count}ê°œ</p>`;
                    html += '<table class="table table-sm table-bordered"><thead><tr><th>ì»¬ëŸ¼ëª…</th><th>íƒ€ì…</th><th>NULL</th><th>ê¸°ë³¸ê°’</th></tr></thead><tbody>';
                    data.columns.forEach(col => {
                        html += `<tr><td>${escapeHtml(col.name)}</td><td>${escapeHtml(col.type)}</td><td>${col.nullable ? 'YES' : 'NO'}</td><td>${col.default || '-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('tableInfoContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('tableInfoModal')).show();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í…Œì´ë¸” ì¸ë±ìŠ¤ ì¡°íšŒ
        async function loadTableIndexes() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/db/table/indexes?table_name=${encodeURIComponent(tableName)}`);
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = `<h6>${escapeHtml(data.table_name)} - ì¸ë±ìŠ¤ (${data.count}ê°œ)</h6>`;
                    if (data.indexes.length > 0) {
                        html += '<table class="table table-sm table-bordered"><thead><tr><th>ì¸ë±ìŠ¤ëª…</th><th>ì •ì˜</th></tr></thead><tbody>';
                        data.indexes.forEach(idx => {
                            html += `<tr><td>${escapeHtml(idx.name)}</td><td><code>${escapeHtml(idx.definition)}</code></td></tr>`;
                        });
                        html += '</tbody></table>';
                    } else {
                        html += '<p class="text-muted">ì¸ë±ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                    document.getElementById('tableInfoContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('tableInfoModal')).show();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í…Œì´ë¸” ì œì•½ì¡°ê±´ ì¡°íšŒ
        async function loadTableConstraints() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/db/table/constraints?table_name=${encodeURIComponent(tableName)}`);
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = `<h6>${escapeHtml(data.table_name)} - ì œì•½ì¡°ê±´ (${data.count}ê°œ)</h6>`;
                    if (data.constraints.length > 0) {
                        html += '<table class="table table-sm table-bordered"><thead><tr><th>ì´ë¦„</th><th>íƒ€ì…</th><th>ì •ì˜</th></tr></thead><tbody>';
                        data.constraints.forEach(con => {
                            html += `<tr><td>${escapeHtml(con.name)}</td><td><span class="badge bg-info">${escapeHtml(con.type_name)}</span></td><td><code>${escapeHtml(con.definition)}</code></td></tr>`;
                        });
                        html += '</tbody></table>';
                    } else {
                        html += '<p class="text-muted">ì œì•½ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                    document.getElementById('tableInfoContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('tableInfoModal')).show();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // DB í†µê³„ ì¡°íšŒ
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/db/stats`);
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = `<h6>ë°ì´í„°ë² ì´ìŠ¤ í†µê³„</h6>`;
                    html += `<p><strong>ì´ í…Œì´ë¸”:</strong> ${data.total_tables}ê°œ | <strong>DB í¬ê¸°:</strong> ${data.database_size}</p>`;
                    html += '<div style="max-height: 400px; overflow-y: auto;"><table class="table table-sm table-bordered"><thead><tr><th>í…Œì´ë¸”ëª…</th><th>í–‰ ìˆ˜</th><th>í¬ê¸°</th></tr></thead><tbody>';
                    data.tables.forEach(tbl => {
                        html += `<tr><td>${escapeHtml(tbl.table_name)}</td><td>${tbl.row_count.toLocaleString()}</td><td>${tbl.size}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    document.getElementById('tableInfoContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('tableInfoModal')).show();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í…Œì´ë¸” ë°ì´í„° ì‚­ì œ (TRUNCATE)
        async function truncateTable() {
            const tableName = document.getElementById('dangerTableSelect').value || document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            if (!confirm(`âš ï¸ ê²½ê³ : '${tableName}' í…Œì´ë¸”ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!\nì •ë§ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            document.getElementById('dangerResult').innerHTML = '<span class="text-muted">ì²˜ë¦¬ ì¤‘...</span>';
            try {
                const response = await fetch(`${API_BASE}/db/table/truncate?table_name=${encodeURIComponent(tableName)}&confirm=true`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('dangerResult').innerHTML = `<span class="badge bg-success">âœ… ${result.data.message}</span>`;
                    loadTableData(); // í…Œì´ë¸” ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                } else {
                    document.getElementById('dangerResult').innerHTML = `<span class="badge bg-danger">âŒ ${result.detail?.message || 'ì˜¤ë¥˜'}</span>`;
                }
            } catch (error) {
                document.getElementById('dangerResult').innerHTML = `<span class="badge bg-danger">âŒ ${error.message}</span>`;
            }
        }

        // í…Œì´ë¸” ì‚­ì œ (DROP)
        async function dropTable() {
            const tableName = document.getElementById('dangerTableSelect').value || document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            if (!confirm(`ğŸš¨ ì‹¬ê°í•œ ê²½ê³ : '${tableName}' í…Œì´ë¸”ì´ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤!\ní…Œì´ë¸” êµ¬ì¡°ì™€ ë°ì´í„°ê°€ ëª¨ë‘ ì‚¬ë¼ì§€ë©° ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\nì •ë§ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            if (!confirm('ì •ë§ë¡œ í™•ì‹¤í•©ë‹ˆê¹Œ? ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤.')) {
                return;
            }
            document.getElementById('dangerResult').innerHTML = '<span class="text-muted">ì²˜ë¦¬ ì¤‘...</span>';
            try {
                const response = await fetch(`${API_BASE}/db/table/drop?table_name=${encodeURIComponent(tableName)}&confirm=true`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('dangerResult').innerHTML = `<span class="badge bg-success">âœ… ${result.data.message}</span>`;
                    loadTables(); // í…Œì´ë¸” ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    document.getElementById('dangerResult').innerHTML = `<span class="badge bg-danger">âŒ ${result.detail?.message || 'ì˜¤ë¥˜'}</span>`;
                }
            } catch (error) {
                document.getElementById('dangerResult').innerHTML = `<span class="badge bg-danger">âŒ ${error.message}</span>`;
            }
        }


        // í†µí•© ì¡°íšŒ: ì•„íŒŒíŠ¸ ê²€ìƒ‰ (ìë™ì™„ì„±)
        let integratedSearchTimeout = null;
        async function searchIntegratedApartments() {
            const query = document.getElementById('integratedApartSearch').value.trim();
            
            if (integratedSearchTimeout) clearTimeout(integratedSearchTimeout);
            
            if (query.length < 2) {
                return;
            }

            integratedSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${SEARCH_API}/apartments?q=${encodeURIComponent(query)}&limit=10`);
                    const result = await response.json();
                    
                    if (result.success && result.data.results.length > 0) {
                        let html = '<div class="small mb-2"><strong>ê²€ìƒ‰ ê²°ê³¼:</strong></div>';
                        html += '<div style="max-height: 200px; overflow-y: auto;">';
                        result.data.results.forEach(apt => {
                            html += `<div class="apart-list-item mb-1" onclick="selectIntegratedApartment(${apt.apt_id})">
                                <strong>${escapeHtml(apt.apt_name)}</strong><br>
                                <small class="text-muted">${escapeHtml(apt.address || apt.sigungu_name || 'ì •ë³´ ì—†ìŒ')}</small>
                            </div>`;
                        });
                        html += '</div>';
                        document.getElementById('integratedApartResult').innerHTML = html;
                    }
                } catch (error) {
                    console.error('ì•„íŒŒíŠ¸ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                }
            }, 300);
        }

        // í†µí•© ì¡°íšŒ: ì•„íŒŒíŠ¸ ì„ íƒ
        function selectIntegratedApartment(aptId) {
            document.getElementById('integratedApartSearch').value = '';
            document.getElementById('integratedApartResult').innerHTML = '';
            loadIntegratedApartments(aptId);
        }

        // í†µí•© ì¡°íšŒ: ì•„íŒŒíŠ¸ ëª©ë¡ ì¡°íšŒ
        async function loadIntegratedApartments(aptId = null) {
            const limit = parseInt(document.getElementById('apartLimit').value) || 50;
            const offset = parseInt(document.getElementById('apartOffset').value) || 0;
            
            document.getElementById('integratedApartResult').innerHTML = '<div class="text-center text-muted">ë¡œë”© ì¤‘...</div>';

            try {
                let url = `${API_BASE}/db/query?table_name=apartments&limit=${limit}&offset=${offset}&order_by=apt_id&order_direction=ASC`;
                if (aptId) {
                    // íŠ¹ì • ì•„íŒŒíŠ¸ IDë¡œ í•„í„°ë§
                    url = `${API_BASE}/db/query?table_name=apartments&limit=1&offset=0&order_by=apt_id&order_direction=ASC`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    let rows = result.data.rows;
                    if (aptId) {
                        rows = rows.filter(r => r.apt_id === aptId);
                    }
                    
                    if (rows.length === 0) {
                        document.getElementById('integratedApartResult').innerHTML = 
                            '<div class="alert alert-warning py-2">ë°ì´í„° ì—†ìŒ</div>';
                        return;
                    }

                    let html = `<div class="alert alert-info py-1 mb-2">ì „ì²´: ${result.data.total.toLocaleString()}ê°œ | ì¡°íšŒ: ${rows.length}ê°œ</div>`;
                    html += '<div class="table-responsive"><table class="table table-sm table-striped table-hover table-bordered">';
                    html += '<thead><tr>';
                    result.data.columns.forEach(col => {
                        html += `<th>${escapeHtml(col)}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    rows.forEach(row => {
                        html += '<tr>';
                        result.data.columns.forEach(col => {
                            const value = row[col];
                            html += `<td>${value !== null && value !== undefined ? escapeHtml(String(value)).substring(0, 100) : '<em class="text-muted">NULL</em>'}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                    document.getElementById('integratedApartResult').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('integratedApartResult').innerHTML = 
                    `<div class="alert alert-danger py-2">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // í†µí•© ì¡°íšŒ: ì§€ì—­ ê²€ìƒ‰ (ìë™ì™„ì„±)
        let regionSearchTimeout = null;
        async function searchRegions() {
            const query = document.getElementById('regionSearch').value.trim();
            
            if (regionSearchTimeout) clearTimeout(regionSearchTimeout);
            
            if (query.length < 1) {
                return;
            }

            regionSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/db/query?table_name=states&limit=20&offset=0&order_by=region_id&order_direction=ASC`);
                    const result = await response.json();
                    
                    if (result.success && result.data.rows.length > 0) {
                        const filtered = result.data.rows.filter(r => 
                            (r.city_name && r.city_name.includes(query)) ||
                            (r.region_name && r.region_name.includes(query)) ||
                            (r.region_code && r.region_code.includes(query))
                        );
                        
                        if (filtered.length > 0) {
                            let html = '<div class="small mb-2"><strong>ê²€ìƒ‰ ê²°ê³¼:</strong></div>';
                            html += '<div style="max-height: 200px; overflow-y: auto;">';
                            filtered.forEach(region => {
                                html += `<div class="apart-list-item mb-1" onclick="selectIntegratedRegion(${region.region_id})">
                                    <strong>${escapeHtml(region.city_name || '')} ${escapeHtml(region.region_name || '')}</strong><br>
                                    <small class="text-muted">ì½”ë“œ: ${escapeHtml(region.region_code || 'N/A')}</small>
                                </div>`;
                            });
                            html += '</div>';
                            document.getElementById('integratedRegionResult').innerHTML = html;
                        }
                    }
                } catch (error) {
                    console.error('ì§€ì—­ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                }
            }, 300);
        }

        // í†µí•© ì¡°íšŒ: ì§€ì—­ ì„ íƒ
        function selectIntegratedRegion(regionId) {
            document.getElementById('regionSearch').value = '';
            document.getElementById('integratedRegionResult').innerHTML = '';
            loadRegions(regionId);
        }

        // í†µí•© ì¡°íšŒ: ì§€ì—­ ëª©ë¡ ì¡°íšŒ
        async function loadRegions(regionId = null) {
            const limit = parseInt(document.getElementById('regionLimit').value) || 50;
            const offset = parseInt(document.getElementById('regionOffset').value) || 0;
            
            document.getElementById('integratedRegionResult').innerHTML = '<div class="text-center text-muted">ë¡œë”© ì¤‘...</div>';

            try {
                let url = `${API_BASE}/db/query?table_name=states&limit=${limit}&offset=${offset}&order_by=region_id&order_direction=ASC`;
                if (regionId) {
                    url = `${API_BASE}/db/query?table_name=states&limit=1&offset=0&order_by=region_id&order_direction=ASC`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    let rows = result.data.rows;
                    if (regionId) {
                        rows = rows.filter(r => r.region_id === regionId);
                    }
                    
                    if (rows.length === 0) {
                        document.getElementById('integratedRegionResult').innerHTML = 
                            '<div class="alert alert-warning py-2">ë°ì´í„° ì—†ìŒ</div>';
                        return;
                    }

                    let html = `<div class="alert alert-info py-1 mb-2">ì „ì²´: ${result.data.total.toLocaleString()}ê°œ | ì¡°íšŒ: ${rows.length}ê°œ</div>`;
                    html += '<div class="table-responsive"><table class="table table-sm table-striped table-hover table-bordered">';
                    html += '<thead><tr>';
                    result.data.columns.forEach(col => {
                        html += `<th>${escapeHtml(col)}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    rows.forEach(row => {
                        html += '<tr>';
                        result.data.columns.forEach(col => {
                            const value = row[col];
                            html += `<td>${value !== null && value !== undefined ? escapeHtml(String(value)).substring(0, 100) : '<em class="text-muted">NULL</em>'}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                    document.getElementById('integratedRegionResult').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('integratedRegionResult').innerHTML = 
                    `<div class="alert alert-danger py-2">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // í†µí•© ì¡°íšŒ: ë§¤ë§¤ ê±°ë˜ ì¡°íšŒ
        async function loadSales() {
            const aptId = document.getElementById('saleAptId').value;
            const limit = parseInt(document.getElementById('saleLimit').value) || 100;
            const offset = parseInt(document.getElementById('saleOffset').value) || 0;
            const search = document.getElementById('saleSearch').value;
            
            document.getElementById('integratedSaleResult').innerHTML = '<div class="text-center text-muted">ë¡œë”© ì¤‘...</div>';

            try {
                let url = `${API_BASE}/db/query?table_name=sales&limit=${limit}&offset=${offset}&order_by=trans_id&order_direction=DESC`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    let rows = result.data.rows;
                    
                    // ì•„íŒŒíŠ¸ ID í•„í„°ë§
                    if (aptId) {
                        rows = rows.filter(r => r.apt_id === parseInt(aptId));
                    }
                    
                    // ê²€ìƒ‰ì–´ í•„í„°ë§
                    if (search) {
                        const searchLower = search.toLowerCase();
                        rows = rows.filter(row => 
                            Object.values(row).some(val => String(val).toLowerCase().includes(searchLower))
                        );
                    }
                    
                    if (rows.length === 0) {
                        document.getElementById('integratedSaleResult').innerHTML = 
                            '<div class="alert alert-warning py-2">ë°ì´í„° ì—†ìŒ</div>';
                        return;
                    }

                    let html = `<div class="alert alert-info py-1 mb-2">
                        ì „ì²´: ${result.data.total.toLocaleString()}ê°œ | ì¡°íšŒ: ${rows.length}ê°œ
                        ${aptId ? ` | í•„í„°: apt_id=${aptId}` : ''}
                    </div>`;
                    html += '<div class="table-responsive"><table class="table table-sm table-striped table-hover table-bordered">';
                    html += '<thead><tr>';
                    result.data.columns.forEach(col => {
                        html += `<th>${escapeHtml(col)}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    rows.forEach(row => {
                        html += '<tr>';
                        result.data.columns.forEach(col => {
                            const value = row[col];
                            let displayValue = value !== null && value !== undefined ? escapeHtml(String(value)).substring(0, 100) : '<em class="text-muted">NULL</em>';
                            // ê°€ê²©ì€ ì²œë‹¨ìœ„ êµ¬ë¶„ í‘œì‹œ
                            if (col === 'trans_price' && value) {
                                displayValue = parseInt(value).toLocaleString() + 'ë§Œì›';
                            }
                            html += `<td>${displayValue}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                    document.getElementById('integratedSaleResult').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('integratedSaleResult').innerHTML = 
                    `<div class="alert alert-danger py-2">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
