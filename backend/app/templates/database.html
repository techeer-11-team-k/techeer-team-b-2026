<div id="view-database" class="view-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold m-0">DB 브라우저 (전문가 시스템)</h4>
        <div class="d-flex gap-2">
            <select id="db-table-select" class="form-select form-select-sm w-auto" onchange="window.loadTableData(this.value)"></select>
            <button class="btn btn-sm btn-outline-secondary" onclick="window.refreshDbTable()">
                <i class="fas fa-sync"></i> 새로고침
            </button>
        </div>
    </div>
    
    <!-- 검색 및 필터 영역 -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small">검색</label>
                    <input type="text" id="db-search-input" class="form-control form-control-sm" placeholder="전체 컬럼 검색..." onkeyup="if(event.key==='Enter') window.applyFilters()">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">정렬 기준</label>
                    <select id="db-sort-by" class="form-select form-select-sm" onchange="window.applyFilters()">
                        <option value="">선택 안함</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">정렬 방향</label>
                    <select id="db-sort-order" class="form-select form-select-sm" onchange="window.applyFilters()">
                        <option value="asc">오름차순</option>
                        <option value="desc">내림차순</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-sm btn-primary" onclick="window.applyFilters()">
                        <i class="fas fa-search"></i> 검색
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.clearFilters()">
                        <i class="fas fa-times"></i> 초기화
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 액션 버튼 -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="window.showAddRowModal()">
                    <i class="fas fa-plus"></i> 행 추가
                </button>
                <button class="btn btn-sm btn-info" onclick="window.exportToCSV()">
                    <i class="fas fa-download"></i> CSV 내보내기
                </button>
                <button class="btn btn-sm btn-warning" onclick="window.showImportModal()">
                    <i class="fas fa-upload"></i> CSV 가져오기
                </button>
                <div class="ms-auto">
                    <span class="small text-muted" id="db-info">총 0개 행, 0개 컬럼</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 데이터 그리드 -->
    <div id="db-grid"></div>
</div>

<!-- 행 추가 모달 -->
<div class="modal fade" id="addRowModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 행 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="add-row-form"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="window.saveNewRow()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- CSV 가져오기 모달 -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">CSV 가져오기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="file" id="csv-file-input" class="form-control" accept=".csv" onchange="window.handleCSVFile(event)">
                <div class="mt-3">
                    <small class="text-muted">CSV 파일을 선택하세요. 첫 번째 행은 컬럼명이어야 합니다.</small>
                </div>
                <div id="csv-preview" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="window.importCSV()" id="import-btn" disabled>가져오기</button>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수 및 함수 정의
window.dbGrid = null;
window.currentTable = null;
window.currentColumns = [];
window.csvData = null;

async function initDatabase() {
    await initDbManager();
}
window.initDatabase = initDatabase;

async function initDbManager() {
    try {
        const res = await fetch(`${API_BASE}/db/tables`);
        const json = await res.json();
        const select = document.getElementById('db-table-select');
        select.innerHTML = '<option value="">테이블 선택...</option>';
        json.data.tables.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.innerText = t;
            select.appendChild(opt);
        });
    } catch(e) {
        console.error(e);
        showToast('테이블 목록 로딩 실패', 'error');
    }
}
window.initDbManager = initDbManager;

function refreshDbTable() {
    if (window.currentTable) {
        loadTableData(window.currentTable);
    }
}
window.refreshDbTable = refreshDbTable;

async function loadTableData(tableName) {
    if(!tableName) return;
    window.currentTable = tableName;
    
    // 로딩 표시
    const gridElement = document.getElementById('db-grid');
    if(gridElement) {
        gridElement.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i><br/>데이터 로딩 중...</div>';
    }
    
    try {
        // 먼저 전체 개수와 컬럼 정보만 가져오기
        const res = await fetch(`${API_BASE}/db/query?table_name=${tableName}&limit=1&offset=0`);
        const json = await res.json();
        
        if(!json.success) {
            showToast('데이터 로딩 실패', 'error');
            return;
        }
        
        window.currentColumns = json.data.columns;
        const totalRows = json.data.total;
        const totalColumns = json.data.columns.length;
        
        // 정렬 기준 드롭다운 업데이트
        const sortSelect = document.getElementById('db-sort-by');
        sortSelect.innerHTML = '<option value="">선택 안함</option>';
        json.data.columns.forEach(col => {
            const opt = document.createElement('option');
            opt.value = col;
            opt.innerText = col;
            sortSelect.appendChild(opt);
        });
        
        // Tabulator 컬럼 설정 (모든 컬럼 표시, 가로 스크롤 가능)
        const cols = json.data.columns.map(c => ({
            title: c,
            field: c,
            editor: "input",
            sorter: "string",
            minWidth: 120,
            widthGrow: 1
        }));
        cols.push({
            title: "작업",
            width: 100,
            frozen: true,
            formatter: "buttonCross",
            cellClick: (e, cell) => window.deleteRow(cell.getRow().getData())
        });
        
        if(window.dbGrid) window.dbGrid.destroy();
        
        // 서버 사이드 페이지네이션을 사용하여 모든 데이터 로드
        window.dbGrid = new Tabulator("#db-grid", {
            columns: cols,
            layout: "fitDataStretch",
            height: "600px",
            pagination: true,
            paginationMode: "remote",
            paginationSize: 100,
            paginationSizeSelector: [50, 100, 200, 500, 1000],
            paginationInitialPage: 1,
            ajaxURL: `${API_BASE}/db/query`,
            ajaxParams: {
                table_name: tableName
            },
            ajaxRequestFunc: function(url, config, params) {
                // Tabulator의 페이지네이션 파라미터를 우리 API 형식으로 변환
                const page = params.page || 1;
                const size = params.size || 100;
                const offset = (page - 1) * size;
                
                const apiUrl = `${window.API_BASE || '/api/v1/admin'}/db/query`;
                return fetch(`${apiUrl}?table_name=${tableName}&limit=${size}&offset=${offset}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if(data.success) {
                            return {
                                last_page: Math.ceil(data.data.total / size),
                                data: data.data.rows
                            };
                        } else {
                            throw new Error(data.message || '데이터 로딩 실패');
                        }
                    })
                    .catch(error => {
                        console.error('DB Grid ajax error:', error);
                        throw error;
                    });
            },
            ajaxResponse: function(url, params, response) {
                return response;
            },
            cellEdited: function(cell) {
                window.updateRow(cell);
            }
        });
        
        // 데이터 로드 완료 후 정보 업데이트
        window.dbGrid.on("dataLoaded", function(data) {
            updateDbInfo(totalRows, totalColumns);
        });
        
        updateDbInfo(totalRows, totalColumns);
    } catch(e) {
        console.error(e);
        showToast('데이터 로딩 실패: ' + e.message, 'error');
        if(gridElement) {
            gridElement.innerHTML = '<div class="alert alert-danger">데이터 로딩 실패: ' + e.message + '</div>';
        }
    }
}

function applyFilters() {
    if(!window.currentTable) return;
    
    const search = document.getElementById('db-search-input').value;
    const sortBy = document.getElementById('db-sort-by').value;
    const sortOrder = document.getElementById('db-sort-order').value;
    
    // 간단한 클라이언트 사이드 필터링 (실제로는 서버 사이드 필터링 권장)
    if(window.dbGrid) {
        if(search) {
            // 모든 컬럼에서 검색
            const filters = window.currentColumns.map(col => ({
                field: col,
                type: "like",
                value: search
            }));
            window.dbGrid.setFilter(filters, "any");
        } else {
            window.dbGrid.clearFilter();
        }
        
        if(sortBy) {
            window.dbGrid.setSort(sortBy, sortOrder);
        }
    }
}
window.applyFilters = applyFilters;

function clearFilters() {
    document.getElementById('db-search-input').value = '';
    document.getElementById('db-sort-by').value = '';
    document.getElementById('db-sort-order').value = 'asc';
    if(window.dbGrid) window.dbGrid.clearFilter();
    refreshDbTable();
}
window.clearFilters = clearFilters;

async function updateRow(cell) {
    const row = cell.getRow().getData();
    const pkField = Object.keys(row).find(k => k.endsWith('_id'));
    if(!pkField) {
        showToast('Primary Key를 찾을 수 없습니다', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API_BASE}/db/row`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table_name: window.currentTable,
                pk_field: pkField,
                pk_value: row[pkField],
                field: cell.getField(),
                value: cell.getValue()
            })
        });
        const json = await res.json();
        if(json.success) {
            showToast('업데이트 완료', 'success');
        } else {
            showToast('업데이트 실패: ' + json.message, 'error');
        }
    } catch(e) {
        showToast('업데이트 실패', 'error');
    }
}
window.updateRow = updateRow;

async function deleteRow(row) {
    if(!confirm("정말 삭제하시겠습니까?")) return;
    
    const pkField = Object.keys(row).find(k => k.endsWith('_id'));
    if(!pkField) {
        showToast('Primary Key를 찾을 수 없습니다', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API_BASE}/db/row?table_name=${window.currentTable}&pk_field=${pkField}&pk_value=${row[pkField]}`, {
            method: 'DELETE'
        });
        const json = await res.json();
        if(json.success) {
            showToast('삭제 완료', 'success');
            refreshDbTable();
        } else {
            showToast('삭제 실패: ' + json.message, 'error');
        }
    } catch(e) {
        showToast('삭제 실패', 'error');
    }
}
window.deleteRow = deleteRow;

function showAddRowModal() {
    if(!window.currentTable) {
        showToast('테이블을 먼저 선택하세요', 'error');
        return;
    }
    
    const form = document.getElementById('add-row-form');
    form.innerHTML = window.currentColumns.map(col => `
        <div class="mb-3">
            <label class="form-label">${col}</label>
            <input type="text" class="form-control" data-field="${col}" placeholder="${col} 입력">
        </div>
    `).join('');
    
    new bootstrap.Modal(document.getElementById('addRowModal')).show();
}
window.showAddRowModal = showAddRowModal;

async function saveNewRow() {
    if(!window.currentTable) return;
    
    const inputs = document.querySelectorAll('#add-row-form input');
    const data = {};
    inputs.forEach(input => {
        const field = input.dataset.field;
        const value = input.value;
        if(value) data[field] = value;
    });
    
    try {
        const res = await fetch(`${API_BASE}/db/row`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table_name: window.currentTable,
                data: data
            })
        });
        const json = await res.json();
        if(json.success) {
            showToast('추가 완료', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addRowModal')).hide();
            refreshDbTable();
        } else {
            showToast('추가 실패: ' + json.message, 'error');
        }
    } catch(e) {
        showToast('추가 실패', 'error');
    }
}
window.saveNewRow = saveNewRow;

async function exportToCSV() {
    if(!window.currentTable) {
        showToast('테이블을 먼저 선택하세요', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API_BASE}/db/export-csv?table_name=${window.currentTable}`);
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${window.currentTable}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        showToast('CSV 내보내기 완료', 'success');
    } catch(e) {
        showToast('CSV 내보내기 실패', 'error');
    }
}
window.exportToCSV = exportToCSV;

function showImportModal() {
    if(!window.currentTable) {
        showToast('테이블을 먼저 선택하세요', 'error');
        return;
    }
    new bootstrap.Modal(document.getElementById('importModal')).show();
}
window.showImportModal = showImportModal;

function handleCSVFile(event) {
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        const headers = lines[0].split(',');
        window.csvData = lines.slice(1).map(line => {
            const values = line.split(',');
            const obj = {};
            headers.forEach((h, i) => {
                obj[h.trim()] = values[i]?.trim() || '';
            });
            return obj;
        }).filter(row => Object.values(row).some(v => v));
        
        document.getElementById('csv-preview').innerHTML = `
            <div class="alert alert-info">
                <strong>${window.csvData.length}개 행</strong>이 감지되었습니다.
            </div>
        `;
        document.getElementById('import-btn').disabled = false;
    };
    reader.readAsText(file);
}
window.handleCSVFile = handleCSVFile;

async function importCSV() {
    if(!window.csvData || window.csvData.length === 0) {
        showToast('가져올 데이터가 없습니다', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API_BASE}/db/import-csv`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table_name: window.currentTable,
                data: window.csvData
            })
        });
        const json = await res.json();
        if(json.success) {
            showToast('CSV 가져오기 완료', 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            refreshDbTable();
        } else {
            showToast('CSV 가져오기 실패: ' + json.message, 'error');
        }
    } catch(e) {
        showToast('CSV 가져오기 실패', 'error');
    }
}
window.importCSV = importCSV;

function updateDbInfo(total, columnCount) {
    const infoElement = document.getElementById('db-info');
    if(infoElement) {
        if(columnCount !== undefined) {
            infoElement.textContent = `총 ${total.toLocaleString()}개 행, ${columnCount}개 컬럼`;
        } else {
            infoElement.textContent = `총 ${total.toLocaleString()}개 행`;
        }
    }
}
window.updateDbInfo = updateDbInfo;
window.loadTableData = loadTableData;
</script>
