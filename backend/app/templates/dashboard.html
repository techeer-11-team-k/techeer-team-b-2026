<div id="view-dashboard" class="view-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">ëŒ€ì‹œë³´ë“œ & í•µì‹¬ ì§€í‘œ</h4>
        <div class="btn-group" role="group" aria-label="ê±°ë˜ ìœ í˜• ì„ íƒ">
            <input type="radio" class="btn-check" name="transaction-type-dashboard" id="type-sale-dashboard" value="sale" checked>
            <label class="btn btn-outline-primary" for="type-sale-dashboard">ë§¤ë§¤</label>
            
            <input type="radio" class="btn-check" name="transaction-type-dashboard" id="type-jeonse-dashboard" value="jeonse">
            <label class="btn btn-outline-primary" for="type-jeonse-dashboard">ì „ì„¸</label>
            
            <input type="radio" class="btn-check" name="transaction-type-dashboard" id="type-wolse-dashboard" value="wolse">
            <label class="btn btn-outline-primary" for="type-wolse-dashboard">ì›”ì„¸</label>
        </div>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card p-3 border-start border-4 border-primary">
                <div class="small text-muted">ì•„íŒŒíŠ¸ ë‹¨ì§€</div>
                <h2 class="my-2 fw-bold" id="stat-apt">-</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 border-start border-4 border-success">
                <div class="small text-muted">ë§¤ë§¤ ë°ì´í„°</div>
                <h2 class="my-2 fw-bold" id="stat-sale">-</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 border-start border-4 border-info">
                <div class="small text-muted">ì „ì›”ì„¸ ë°ì´í„°</div>
                <h2 class="my-2 fw-bold" id="stat-rent">-</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 border-start border-4 border-warning">
                <div class="small text-muted">ì§€ì—­ ì½”ë“œ</div>
                <h2 class="my-2 fw-bold" id="stat-region">-</h2>
            </div>
        </div>
    </div>
    
    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold">ğŸ“‰ ì›”ë³„ ê±°ë˜ ì¶”ì´</div>
                <div class="card-body">
                    <div id="chart-trend" class="chart-box"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold">ğŸ“Š ê°€ê²©ëŒ€ë³„ ë¶„í¬</div>
                <div class="card-body">
                    <div id="chart-price" class="chart-box"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë­í‚¹ ë¦¬ìŠ¤íŠ¸ -->
    <div class="row">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between">
                    <span>ğŸ† ìµœê³ ê°€ ê±°ë˜ ìˆœìœ„ (Top 10)</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.loadRank('price')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="rank-price" class="list-group list-group-flush small">Loading...</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between">
                    <span>ğŸ”¥ ê±°ë˜ëŸ‰ ìƒìœ„ ì•„íŒŒíŠ¸ (Top 10)</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.loadRank('volume')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="rank-volume" class="list-group list-group-flush small">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì¤‘ë³µ ì„ ì–¸ ë°©ì§€
if (typeof window.currentTransactionType === 'undefined') {
    window.currentTransactionType = 'sale'; // ê¸°ë³¸ê°’: ë§¤ë§¤
}

// ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
if (typeof window.dashboardCharts === 'undefined') {
    window.dashboardCharts = {
        trend: null,
        price: null
    };
}

// ìë™ ìƒˆë¡œê³ ì¹¨ ì¸í„°ë²Œ ID ì €ì¥
if (typeof window.dashboardRefreshInterval === 'undefined') {
    window.dashboardRefreshInterval = null;
}

async function refreshDashboard() {
    // ëŒ€ì‹œë³´ë“œ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const viewDashboard = document.getElementById('view-dashboard');
    if (!viewDashboard || viewDashboard.offsetParent === null) {
        // ëŒ€ì‹œë³´ë“œ ë·°ê°€ ì—†ê±°ë‚˜ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        return;
    }
    
    // í†µê³„ ì¹´ë“œ, ì°¨íŠ¸, ë­í‚¹ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨
    // ê° í•¨ìˆ˜ê°€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•˜ì—¬ í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ê²ƒë“¤ì´ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ í•¨
    try {
        await loadStats();
    } catch(e) {
        console.error('Error loading stats:', e);
    }
    
    try {
        await initCharts();
    } catch(e) {
        console.error('Error initializing charts:', e);
    }
    
    try {
        await loadRank('price');
    } catch(e) {
        console.error('Error loading price rank:', e);
    }
    
    try {
        await loadRank('volume');
    } catch(e) {
        console.error('Error loading volume rank:', e);
    }
}

async function initDashboard() {
    // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì •ë¦¬
    if (window.dashboardRefreshInterval) {
        clearInterval(window.dashboardRefreshInterval);
        window.dashboardRefreshInterval = null;
    }
    
    // DOMì´ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    await new Promise(resolve => setTimeout(resolve, 200));
    
    // í•„ìˆ˜ ìš”ì†Œë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ - ëŒ€ì‹œë³´ë“œ ë·°ì¸ì§€ í™•ì¸
    const viewDashboard = document.getElementById('view-dashboard');
    if (!viewDashboard) {
        console.warn('Dashboard view not found, skipping initialization');
        return;
    }
    
    const requiredElements = ['rank-price', 'rank-volume', 'stat-apt', 'stat-sale', 'stat-rent', 'stat-region', 'chart-trend', 'chart-price'];
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        console.warn('Some required elements are missing:', missingElements);
        // í•„ìˆ˜ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
        return;
    }
    
    // ê±°ë˜ ìœ í˜• ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('input[name="transaction-type-dashboard"]').forEach(radio => {
        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
        radio.removeEventListener('change', handleDashboardTransactionTypeChange);
        radio.addEventListener('change', handleDashboardTransactionTypeChange);
    });
    
    // ì´ˆê¸° ë¡œë“œ
    await refreshDashboard();
    
    // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ (ëŒ€ì‹œë³´ë“œ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œë§Œ)
    window.dashboardRefreshInterval = setInterval(() => {
        // í˜„ì¬ ëŒ€ì‹œë³´ë“œ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        const currentView = document.getElementById('view-dashboard');
        if (currentView && currentView.offsetParent !== null) {
            refreshDashboard();
        } else {
            // ëŒ€ì‹œë³´ë“œê°€ ì•„ë‹Œ ë·°ë¡œ ì „í™˜ë˜ì—ˆìœ¼ë©´ ì¸í„°ë²Œ ì •ë¦¬
            if (window.dashboardRefreshInterval) {
                clearInterval(window.dashboardRefreshInterval);
                window.dashboardRefreshInterval = null;
            }
        }
    }, 5000);
}

// ê±°ë˜ ìœ í˜• ë³€ê²½ í•¸ë“¤ëŸ¬ë¥¼ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
function handleDashboardTransactionTypeChange() {
    window.currentTransactionType = this.value;
    refreshDashboard();
}
window.initDashboard = initDashboard;
window.refreshDashboard = refreshDashboard;

async function loadStats() {
    // ëŒ€ì‹œë³´ë“œ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const viewDashboard = document.getElementById('view-dashboard');
    if (!viewDashboard || viewDashboard.offsetParent === null) {
        return;
    }
    
    const API_BASE = window.API_BASE || '/api/v1/admin';
    const tables = ['apartments', 'sales', 'rents', 'states'];
    const ids = ['stat-apt', 'stat-sale', 'stat-rent', 'stat-region'];
    for(let i=0; i<tables.length; i++) {
        try {
            const element = document.getElementById(ids[i]);
            if (!element) {
                // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ê±´ë„ˆë›°ê¸° (ê²½ê³  ë¡œê·¸ ì œê±°)
                continue;
            }
            const res = await fetch(`${API_BASE}/db/query?table_name=${tables[i]}&limit=1`);
            const json = await res.json();
            if(json.success) {
                element.innerText = json.data.total.toLocaleString();
            }
        } catch(e) {
            console.error(e);
        }
    }
}

async function initCharts() {
    // ëŒ€ì‹œë³´ë“œ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const viewDashboard = document.getElementById('view-dashboard');
    if (!viewDashboard || viewDashboard.offsetParent === null) {
        return;
    }
    
    const API_BASE = window.API_BASE || '/api/v1/admin';
    
    // 1. Trend Chart
    const trendElement = document.getElementById('chart-trend');
    if (!trendElement) return;
    
    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ dispose
    if (window.dashboardCharts.trend) {
        window.dashboardCharts.trend.dispose();
    }
    
    const trendChart = echarts.init(trendElement);
    window.dashboardCharts.trend = trendChart;
    
    try {
        const res = await fetch(`${API_BASE}/stats/charts?type=monthly_trend&transaction_type=${window.currentTransactionType}`);
        const json = await res.json();
        if(json.success && json.data.categories && json.data.categories.length > 0) {
            trendChart.setOption({
                tooltip: {trigger: 'axis'},
                legend: {data: ['í‰ê· ê°€', 'ê±°ë˜ëŸ‰']},
                xAxis: {type: 'category', data: json.data.categories},
                yAxis: [
                    {
                        type:'value', 
                        name:'ì–µì›', 
                        position:'left',
                        axisLabel: {
                            formatter: function(value) {
                                return value + 'ì–µ';
                            }
                        }
                    },
                    {type:'value', name:'ê±´', position:'right'}
                ],
                series: [
                    {
                        name:'í‰ê· ê°€',
                        type:'line',
                        data: json.data.price, // ì´ë¯¸ ì–µì› ë‹¨ìœ„ë¡œ ë³€í™˜ë¨
                        yAxisIndex:0,
                        smooth:true,
                        itemStyle: {color: '#3b82f6'},
                        tooltip: {
                            formatter: function(params) {
                                return params.name + '<br/>' + params.seriesName + ': ' + params.value.toFixed(1) + 'ì–µì›';
                            }
                        }
                    },
                    {
                        name:'ê±°ë˜ëŸ‰',
                        type:'bar',
                        data: json.data.volume,
                        yAxisIndex:1,
                        itemStyle:{color:'#94a3b8'}
                    }
                ]
            });
        } else {
            const trendEl = document.getElementById('chart-trend');
            if (trendEl) {
                trendEl.innerHTML = '<div class="text-center p-5 text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }
    } catch(e) {
        console.error(e);
        const trendEl = document.getElementById('chart-trend');
        if (trendEl) {
            trendEl.innerHTML = '<div class="text-center p-5 text-danger">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</div>';
        }
    }

    // 2. Price Dist Chart
    const priceElement = document.getElementById('chart-price');
    if (!priceElement) return;
    
    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ dispose
    if (window.dashboardCharts.price) {
        window.dashboardCharts.price.dispose();
    }
    
    const priceChart = echarts.init(priceElement);
    window.dashboardCharts.price = priceChart;
    
    try {
        const res = await fetch(`${API_BASE}/stats/charts?type=price_range`);
        const json = await res.json();
        if(json.success && json.data && json.data.length > 0) {
            priceChart.setOption({
                tooltip: {trigger: 'item'},
                legend: {orient: 'vertical', left: 'left'},
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: json.data,
                    emphasis: {itemStyle: {shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)'}}
                }]
            });
        } else {
            const priceEl = document.getElementById('chart-price');
            if (priceEl) {
                priceEl.innerHTML = '<div class="text-center p-5 text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }
    } catch(e) {
        console.error(e);
        const priceEl = document.getElementById('chart-price');
        if (priceEl) {
            priceEl.innerHTML = '<div class="text-center p-5 text-danger">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</div>';
        }
    }
    
    // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ë“±ë¡)
    if (!window.dashboardResizeHandler) {
        window.dashboardResizeHandler = () => {
            if (window.dashboardCharts.trend) {
                window.dashboardCharts.trend.resize();
            }
            if (window.dashboardCharts.price) {
                window.dashboardCharts.price.resize();
            }
        };
        window.addEventListener('resize', window.dashboardResizeHandler);
    }
}

async function loadRank(type) {
    // ëŒ€ì‹œë³´ë“œ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const viewDashboard = document.getElementById('view-dashboard');
    if (!viewDashboard || viewDashboard.offsetParent === null) {
        return;
    }
    
    const API_BASE = window.API_BASE || '/api/v1/admin';
    const container = document.getElementById(type === 'price' ? 'rank-price' : 'rank-volume');
    if (!container) {
        // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ê±´ë„ˆë›°ê¸° (ê²½ê³  ë¡œê·¸ ì œê±°)
        return;
    }
    try {
        const res = await fetch(`${API_BASE}/stats/ranking?type=${type}&transaction_type=${window.currentTransactionType}&limit=10`);
        const json = await res.json();
        
        if(!json.success || !json.data || json.data.length === 0) {
            container.innerHTML = '<div class="list-group-item text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }
        
        container.innerHTML = json.data.map((item, idx) => `
            <div class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                <div class="d-flex align-items-center text-truncate">
                    <span class="badge bg-${idx<3?'danger':'light'} text-${idx<3?'white':'dark'} me-3 rounded-pill" style="width:24px">${idx+1}</span>
                    <div>
                        <div class="fw-bold text-truncate" style="max-width:180px">${item.apt_name || '-'}</div>
                        <div class="text-muted small">${item.region || '-'}</div>
                    </div>
                </div>
                <div class="text-end ms-2">
                    <div class="fw-bold text-primary">${item.rank_val || '-'}</div>
                    <div class="text-muted small" style="font-size:0.75rem">${item.date || '-'}</div>
                </div>
            </div>
        `).join('');
    } catch(e) {
        console.error(e);
        container.innerHTML = '<div class="list-group-item text-center text-danger">ë¡œë”© ì‹¤íŒ¨</div>';
    }
}
window.loadRank = loadRank;
</script>
