name: Backend CD - Deploy to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/backend-cd.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR }}

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            cd "$PROJECT_DIR" || {
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $PROJECT_DIR"
              echo "í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € í´ë¡ í•˜ì„¸ìš”:"
              echo "git clone https://github.com/techeer-11-team-k/techeer-team-b-2026.git"
              exit 1
            }
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Docker Composeë¡œ ì¬ë°°í¬
            echo "ğŸ³ Docker Compose ì¬ë°°í¬..."
            docker compose -f docker-compose.prod.yml pull || true
            docker compose -f docker-compose.prod.yml up -d --build
            
            # í—¬ìŠ¤ ì²´í¬ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°, 5ì´ˆë§ˆë‹¤ ì¬ì‹œë„)
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬..."
            MAX_RETRIES=12
            RETRY_INTERVAL=5
            RETRY_COUNT=0
            HEALTH_CHECK_SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep $RETRY_INTERVAL
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $RETRY_COUNT/$MAX_RETRIES..."
              
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                HEALTH_CHECK_SUCCESS=true
                break
              fi
            done
            
            if [ "$HEALTH_CHECK_SUCCESS" = false ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)"
              echo "ğŸ“‹ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
              docker compose -f docker-compose.prod.yml ps backend
              echo ""
              echo "ğŸ“‹ ë°±ì—”ë“œ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
              docker compose -f docker-compose.prod.yml logs --tail=100 backend
              echo ""
              echo "ğŸ“‹ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ í—¬ìŠ¤ ì²´í¬:"
              docker compose -f docker-compose.prod.yml exec -T backend curl -f http://localhost:8000/health || echo "ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
              exit 1
            fi
            
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "âœ¨ ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨!"
          fi

      - name: Get deployment details
        if: always()
        id: deployment_details
        run: |
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Slack Notification
        if: always() && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          webhook-url: ${{ env.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "ğŸš€ ë°±ì—”ë“œ ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && 'âœ… ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ' || 'âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ job.status == 'success' && 'ğŸ‰ *ë¼ ì– í˜¸ ìš° !*' || 'ğŸ’¥ *ì„±ê³µì ìœ¼ë¡œ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.*' }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“‹ ì›Œí¬í”Œë¡œìš°:*\nBackend CD - Deploy to EC2"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸŒ¿ ë¸Œëœì¹˜:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“¦ ì»¤ë°‹:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}|`${GITHUB_SHA:0:7}`>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ‘¤ ì‘ì„±ì:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ• ë°°í¬ ì‹œê°„:*\n${{ steps.deployment_details.outputs.deployment_time }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸƒ ì‹¤í–‰ ID:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|#${GITHUB_RUN_NUMBER}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ–¥ï¸ ì„œë²„:*\nEC2 (${{ env.EC2_HOST }})"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“ í”„ë¡œì íŠ¸ ê²½ë¡œ:*\n`${{ env.PROJECT_DIR }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€:*\n```${{ steps.deployment_details.outputs.commit_message }}```"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ”— ìƒì„¸ ì •ë³´:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|GitHub Actionsì—ì„œ í™•ì¸í•˜ê¸°>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ“Š ì €ì¥ì†Œ: <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}|${GITHUB_REPOSITORY}>"
                    }
                  ]
                }
              ]
            }
