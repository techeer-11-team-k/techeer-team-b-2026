name: Backend CD - Deploy to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/backend-cd.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR }}

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            cd "$PROJECT_DIR" || {
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $PROJECT_DIR"
              echo "í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € í´ë¡ í•˜ì„¸ìš”:"
              echo "git clone https://github.com/techeer-11-team-k/techeer-team-b-2026.git"
              exit 1
            }
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Docker Composeë¡œ ì¬ë°°í¬
            echo "ğŸ³ Docker Compose ì¬ë°°í¬..."
            docker compose -f docker-compose.prod.yml pull || true
            docker compose -f docker-compose.prod.yml up -d --build
            
            # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ì´ˆê¸° ëŒ€ê¸°
            echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘ (10ì´ˆ)..."
            sleep 10
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
            CONTAINER_STATUS=$(docker compose -f docker-compose.prod.yml ps backend --format json 2>/dev/null | grep -o '"State":"[^"]*"' | cut -d'"' -f4 || echo "")
            if [ -z "$CONTAINER_STATUS" ]; then
              echo "âš ï¸ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤..."
            elif [ "$CONTAINER_STATUS" != "running" ]; then
              echo "âš ï¸ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ: $CONTAINER_STATUS (ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤)"
            else
              echo "âœ… ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            fi
            
            # FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            MAX_STARTUP_WAIT=60
            STARTUP_WAIT_COUNT=0
            APP_READY=false
            
            while [ $STARTUP_WAIT_COUNT -lt $MAX_STARTUP_WAIT ]; do
              sleep 3
              STARTUP_WAIT_COUNT=$((STARTUP_WAIT_COUNT + 3))
              
              # ë¡œê·¸ì—ì„œ "Application startup complete" í™•ì¸
              LOGS=$(docker compose -f docker-compose.prod.yml logs backend 2>&1 | tail -30)
              
              if echo "$LOGS" | grep -qE "(Application startup complete|ì„œë²„ê°€ ìš”ì²­ì„ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤)"; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì™„ë£Œ ê°ì§€! (${STARTUP_WAIT_COUNT}ì´ˆ ê²½ê³¼)"
                APP_READY=true
                break
              fi
              
              # í¬íŠ¸ê°€ ì—´ë ¤ìˆê³  ì‹¤ì œë¡œ ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸ (ë” ê¸´ íƒ€ì„ì•„ì›ƒ)
              if nc -z localhost 8000 2>/dev/null; then
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 --connect-timeout 3 http://localhost:8000/health 2>/dev/null || echo "000")
                if [ "$HTTP_CODE" = "200" ]; then
                  echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ! (${STARTUP_WAIT_COUNT}ì´ˆ ê²½ê³¼, HTTP $HTTP_CODE)"
                  APP_READY=true
                  break
                elif [ "$HTTP_CODE" != "000" ]; then
                  echo "  â„¹ï¸ HTTP ì‘ë‹µ ë°›ìŒ (ì½”ë“œ: $HTTP_CODE, ê³„ì† ëŒ€ê¸° ì¤‘...)"
                fi
              fi
              
              echo "  â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... (${STARTUP_WAIT_COUNT}/${MAX_STARTUP_WAIT}ì´ˆ)"
            done
            
            if [ "$APP_READY" = false ]; then
              echo "âš ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì™„ë£Œë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í—¬ìŠ¤ ì²´í¬ë¥¼ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤..."
            fi
            
            # ì¶”ê°€ ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ ì¶”ê°€ ì•ˆì •í™” ëŒ€ê¸° (5ì´ˆ)..."
            sleep 5
            
            # ìµœì¢… í—¬ìŠ¤ ì²´í¬ (ë” ê¸´ ëŒ€ê¸° ì‹œê°„ê³¼ ì¬ì‹œë„)
            echo "ğŸ¥ ìµœì¢… í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
            MAX_RETRIES=20
            RETRY_INTERVAL=5
            RETRY_COUNT=0
            HEALTH_CHECK_SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $RETRY_COUNT/$MAX_RETRIES..."
              
              # í¬íŠ¸ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
              if ! nc -z localhost 8000 2>/dev/null; then
                echo "  â³ í¬íŠ¸ 8000ì´ ì•„ì§ ì—´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤..."
                sleep $RETRY_INTERVAL
                continue
              fi
              
              # ì‹¤ì œ HTTP í—¬ìŠ¤ ì²´í¬ (ë” ê¸´ íƒ€ì„ì•„ì›ƒ)
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --connect-timeout 5 http://localhost:8000/health 2>/dev/null || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ! (HTTP $HTTP_CODE)"
                HEALTH_CHECK_SUCCESS=true
                break
              elif [ "$HTTP_CODE" = "000" ]; then
                echo "  â³ ì—°ê²° ì‹¤íŒ¨ (Connection reset ë˜ëŠ” timeout)..."
                # ìµœê·¼ ë¡œê·¸ í™•ì¸
                RECENT_LOGS=$(docker compose -f docker-compose.prod.yml logs backend 2>&1 | tail -5)
                echo "  ğŸ“‹ ìµœê·¼ ë¡œê·¸: $RECENT_LOGS"
              else
                echo "  â³ í—¬ìŠ¤ ì²´í¬ ëŒ€ê¸° ì¤‘... (HTTP $HTTP_CODE)"
              fi
              
              sleep $RETRY_INTERVAL
            done
            
            if [ "$HEALTH_CHECK_SUCCESS" = false ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)"
              echo ""
              echo "ğŸ“‹ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
              docker compose -f docker-compose.prod.yml ps backend
              echo ""
              echo "ğŸ“‹ ë°±ì—”ë“œ ë¡œê·¸ (ìµœê·¼ 150ì¤„):"
              docker compose -f docker-compose.prod.yml logs --tail=150 backend
              echo ""
              echo "ğŸ“‹ í¬íŠ¸ í™•ì¸:"
              ss -tlnp | grep 8000 || echo "í¬íŠ¸ 8000ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo ""
              echo "ğŸ“‹ ì§ì ‘ í—¬ìŠ¤ ì²´í¬ í…ŒìŠ¤íŠ¸:"
              curl -v http://localhost:8000/health || echo "curl ì‹¤íŒ¨"
              exit 1
            fi
            
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "âœ¨ ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨!"
          fi

      - name: Get deployment details
        if: always()
        id: deployment_details
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ JSON-safeí•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
          COMMIT_MSG=$(git log -1 --pretty=%B | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g' | head -c 500)
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Slack Notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Slack Webhook URLì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ "$SLACK_WEBHOOK_URL" = "" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi
          
          STATUS_EMOJI="${{ job.status == 'success' && 'âœ…' || 'âŒ' }}"
          STATUS_TEXT="${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          FUN_MESSAGE="${{ job.status == 'success' && 'ğŸ‰ *ë¼ ì– í˜¸ ìš° !*' || 'ğŸ’¥ *ì„±ê³µì ìœ¼ë¡œ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.*' }}"
          
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ JSON-safeí•˜ê²Œ ì²˜ë¦¬ (íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„)
          COMMIT_MSG="${{ steps.deployment_details.outputs.commit_message }}"
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/`/\\`/g' | sed 's/\$/\\$/g')
          
          # JSON payload ìƒì„± (jqë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì§ì ‘ ìƒì„±)
          PAYLOAD=$(cat <<JSON
          {
            "text": "ğŸš€ ë°±ì—”ë“œ ë°°í¬ ${STATUS_TEXT}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${STATUS_EMOJI} ë°±ì—”ë“œ ë°°í¬ ${STATUS_TEXT}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${FUN_MESSAGE}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“‹ ì›Œí¬í”Œë¡œìš°:*\nBackend CD - Deploy to EC2"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸŒ¿ ë¸Œëœì¹˜:*\n\`${{ github.ref_name }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“¦ ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|\`${GITHUB_SHA:0:7}\`>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ‘¤ ì‘ì„±ì:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ• ë°°í¬ ì‹œê°„:*\n${{ steps.deployment_details.outputs.deployment_time }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸƒ ì‹¤í–‰ ID:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ–¥ï¸ ì„œë²„:*\nEC2 (${{ env.EC2_HOST }})"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ í”„ë¡œì íŠ¸ ê²½ë¡œ:*\n\`${{ env.PROJECT_DIR }}\`"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€:*\n\`\`\`${COMMIT_MSG_ESCAPED}\`\`\`"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ”— ìƒì„¸ ì •ë³´:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actionsì—ì„œ í™•ì¸í•˜ê¸°>"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ğŸ“Š ì €ì¥ì†Œ: <${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                  }
                ]
              }
            ]
          }
          JSON
          )
          
          # JSON ìœ íš¨ì„± ê²€ì‚¬ ë° ì „ì†¡
          echo "$PAYLOAD" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "$PAYLOAD" \
              "$SLACK_WEBHOOK_URL" && echo "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì„±ê³µ" || echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          else
            echo "âŒ JSON payloadê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ë©”ì‹œì§€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤."
            SIMPLE_PAYLOAD="{\"text\": \"ğŸš€ ë°±ì—”ë“œ ë°°í¬ ${STATUS_TEXT} - ${{ github.ref_name }} - ${{ github.actor }}\"}"
            curl -X POST -H 'Content-type: application/json' \
              --data "$SIMPLE_PAYLOAD" \
              "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          fi
