name: Backend CD - Deploy to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/backend-cd.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR }}

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            cd "$PROJECT_DIR" || {
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $PROJECT_DIR"
              echo "í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € í´ë¡ í•˜ì„¸ìš”:"
              echo "git clone https://github.com/techeer-11-team-k/techeer-team-b-2026.git"
              exit 1
            }
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Docker Composeë¡œ ì¬ë°°í¬
            echo "ğŸ³ Docker Compose ì¬ë°°í¬..."
            docker compose -f docker-compose.prod.yml pull || true
            docker compose -f docker-compose.prod.yml up -d --build
            
            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬..."
            sleep 10
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
            else
              echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸:"
              docker compose -f docker-compose.prod.yml logs --tail=50 backend
              exit 1
            fi
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "âœ¨ ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨!"
          fi

      - name: Slack Notification
        if: always() && secrets.SLACK_WEBHOOK_URL != null
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "ğŸš€ ë°±ì—”ë“œ ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && 'âœ… ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ' || 'âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì›Œí¬í”Œë¡œìš°:*\nBackend CD - Deploy to EC2"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}|${GITHUB_SHA:0:7}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ìƒì„¸ ì •ë³´:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|GitHub Actionsì—ì„œ í™•ì¸>"
                  }
                }
              ]
            }
