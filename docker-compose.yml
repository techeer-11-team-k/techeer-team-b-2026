# ============================================================
# ğŸ  ë¶€ë™ì‚° ë¶„ì„ í”Œë«í¼ - í†µí•© Docker Compose
# ============================================================
# ì‹¤í–‰ ë°©ë²•:
# - Backendë§Œ: docker-compose up -d
# - Frontend í¬í•¨: docker-compose --profile frontend up -d
# ì¢…ë£Œ: docker-compose down
# ë¡œê·¸: docker-compose logs -f [service_name]
# ============================================================

version: '3.8'

services:
  # --------------------------------------------------------
  # ğŸ—„ï¸ PostgreSQL + PostGIS ë°ì´í„°ë² ì´ìŠ¤
  # --------------------------------------------------------
  db:
    image: postgis/postgis:15-3.3
    container_name: realestate-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-realestate}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # ì´ˆê¸°í™” SQL ìŠ¤í¬ë¦½íŠ¸ (ì„ íƒ)
      # - ./backend/scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-realestate}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - realestate-network

  # --------------------------------------------------------
  # ğŸ”´ Redis ìºì‹œ
  # --------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: realestate-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - realestate-network

  # --------------------------------------------------------
  # ğŸš€ Backend API (FastAPI)
  # --------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: realestate-backend
    restart: unless-stopped
    environment:
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë³¸ ì„¤ì •
      PROJECT_NAME: ${PROJECT_NAME:-ë¶€ë™ì‚° ë°ì´í„° ë¶„ì„ ì„œë¹„ìŠ¤}
      VERSION: ${VERSION:-1.0.0}
      DEBUG: ${DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      API_V1_STR: /api/v1
      
      # ë°ì´í„°ë² ì´ìŠ¤ URL (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í˜¸ìŠ¤íŠ¸ëª… ì‚¬ìš©)
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-realestate}
      
      # Redis URL
      REDIS_URL: redis://redis:6379/0
      
      # JWT ì¸ì¦ ì„¤ì •
      SECRET_KEY: ${SECRET_KEY:-change-me-in-production}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-1440}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      
      # CORS ì„¤ì •
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8081}
      
      # ì™¸ë¶€ API í‚¤
      MOLIT_API_KEY: ${MOLIT_API_KEY:-}
      KAKAO_REST_API_KEY: ${KAKAO_REST_API_KEY:-}
      NAVER_CLIENT_ID: ${NAVER_CLIENT_ID:-}
      NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      
      # ì´ë©”ì¼ ì„¤ì •
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      # ê°œë°œ ì‹œ ì½”ë“œ ë³€ê²½ ë°˜ì˜ (í•« ë¦¬ë¡œë“œ)
      - ./backend/app:/app/app:ro
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - realestate-network
    # ê°œë°œ ëª¨ë“œ: hot reload í™œì„±í™”
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # --------------------------------------------------------
  # ğŸ“± Frontend (Expo)
  # --------------------------------------------------------
  # âš ï¸ ì£¼ì˜: frontend í´ë”ì— package.jsonì´ ìˆì–´ì•¼ ë¹Œë“œë©ë‹ˆë‹¤.
  # ì´ˆê¸°í™” ë°©ë²•: cd frontend && npx create-expo-app@latest .
  # 
  # ì‹¤í–‰ ë°©ë²•:
  # - Backendë§Œ: docker-compose up -d
  # - Frontend í¬í•¨: docker-compose --profile frontend up -d
  frontend:
    profiles:
      - frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: realestate-frontend
    restart: unless-stopped
    environment:
      # Backend API URL (Expo í™˜ê²½ë³€ìˆ˜ëŠ” EXPO_PUBLIC_ ì ‘ë‘ì‚¬ ì‚¬ìš©)
      EXPO_PUBLIC_API_URL: ${EXPO_PUBLIC_API_URL:-http://localhost:8000/api/v1}
      # ë˜ëŠ” ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ 
      # EXPO_PUBLIC_API_URL: http://backend:8000/api/v1
      
      # ì¹´ì¹´ì˜¤ JavaScript API í‚¤ (ì§€ë„ SDKìš©)
      EXPO_PUBLIC_KAKAO_JAVASCRIPT_KEY: ${KAKAO_JAVASCRIPT_KEY:-}
      
      # Node.js í™˜ê²½
      NODE_ENV: ${NODE_ENV:-development}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
      - "8081:8081"  # Expo Metro bundler
    volumes:
      # ê°œë°œ ì‹œ ì½”ë“œ ë³€ê²½ ë°˜ì˜ (í•« ë¦¬ë¡œë“œ)
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - realestate-network
    # ê°œë°œ ëª¨ë“œ (Expo)
    command: npx expo start --web
    # ë˜ëŠ” ë„¤ì´í‹°ë¸Œ ëª¨ë“œ
    # command: npx expo start
    # frontendê°€ ì•„ì§ ì—†ìœ¼ë©´ ì´ ì„œë¹„ìŠ¤ë¥¼ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”

# --------------------------------------------------------
# ğŸ“¦ ë³¼ë¥¨ ì •ì˜
# --------------------------------------------------------
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

# --------------------------------------------------------
# ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ì˜
# --------------------------------------------------------
networks:
  realestate-network:
    driver: bridge
