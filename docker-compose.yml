# ============================================================
# ğŸ  ë¶€ë™ì‚° ë¶„ì„ í”Œë«í¼ - í†µí•© Docker Compose
# ============================================================
# ì‹¤í–‰ ë°©ë²•:
# - ì „ì²´ ì‹¤í–‰: docker-compose up -d
# - íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ: docker-compose up -d [service_name]
# ì¢…ë£Œ: docker-compose down
# ë¡œê·¸: docker-compose logs -f [service_name]
# ============================================================

services:
  # --------------------------------------------------------
  # ğŸ—„ï¸ PostgreSQL + PostGIS ë°ì´í„°ë² ì´ìŠ¤
  # --------------------------------------------------------
  db:
    image: postgis/postgis:15-3.3
    container_name: realestate-db
    restart: always
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # ì´ˆê¸°í™” SQL ìŠ¤í¬ë¦½íŠ¸ (ì»¨í…Œì´ë„ˆ ìµœì´ˆ ìƒì„± ì‹œ ìë™ ì‹¤í–‰)
      # ì£¼ì˜: ì´ë¯¸ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
      - ./backend/scripts/init_db.sql:/docker-entrypoint-initdb.d/01-init_schema.sql:ro
    networks:
      - realestate-network

  # --------------------------------------------------------
  # ğŸ”´ Redis ìºì‹œ
  # --------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: realestate-redis
    restart: always
    env_file:
      - .env
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - realestate-network

  # --------------------------------------------------------
  # ğŸš€ Backend API (FastAPI)
  # --------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: realestate-backend
    restart: always
    env_file:
      - .env
    environment:
      # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ í•„ìš”í•œ ê°’ë§Œ ì˜¤ë²„ë¼ì´ë“œ
      # ë°ì´í„°ë² ì´ìŠ¤ URL (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í˜¸ìŠ¤íŠ¸ëª… ì‚¬ìš©)
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      # Redis URL (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í˜¸ìŠ¤íŠ¸ëª… ì‚¬ìš©)
      REDIS_URL: redis://redis:6379/0
      # API ë²„ì „ ê³ ì •ê°’
      API_V1_STR: /api/v1
    ports:
      - "${BACKEND_PORT}:8000"
    volumes:
      # ê°œë°œ ì‹œ ì½”ë“œ ë³€ê²½ ë°˜ì˜ (í•« ë¦¬ë¡œë“œ)
      - ./backend/app:/app/app:ro
      # scripts í´ë”ë„ ë§ˆìš´íŠ¸ (ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ìš©)
      - ./backend/scripts:/app/scripts:ro
      # DB ë°±ì—…/ë³µì›ìš© ë³¼ë¥¨ ë§ˆìš´íŠ¸
      - ./db_backup:/app/backups
    depends_on:
      - db
      - redis
    networks:
      - realestate-network
    # ê°œë°œ ëª¨ë“œ: hot reload í™œì„±í™”
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # --------------------------------------------------------
  # ğŸ“± Frontend (React + Vite)
  # --------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: realestate-frontend
    restart: always
    env_file:
      - .env
    environment:
      # Vite í™˜ê²½ ë³€ìˆ˜ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
      VITE_API_BASE_URL: ${VITE_API_BASE_URL}
      VITE_CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY}
      VITE_KAKAO_JAVASCRIPT_KEY: ${VITE_KAKAO_JAVASCRIPT_KEY}
    ports:
      - "${FRONTEND_PORT}:3000"
    volumes:
      # ê°œë°œ ì‹œ ì½”ë“œ ë³€ê²½ ë°˜ì˜ (í•« ë¦¬ë¡œë“œ)
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - realestate-network

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    restart: always
    ports:
     - 8001:81
    volumes:
     - pgadmin_data_dev:/var/lib/pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@gmail.com
      - PGADMIN_DEFAULT_PASSWORD=secret
      - PGADMIN_LISTEN_PORT=81
    networks:
      - realestate-network  


# --------------------------------------------------------
# ğŸ“¦ ë³¼ë¥¨ ì •ì˜
# --------------------------------------------------------
volumes:
  postgres_data:
    driver: local
  pgadmin_data_dev:
  redis_data:
    driver: local

# --------------------------------------------------------
# ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ì˜
# --------------------------------------------------------
networks:
  realestate-network:
    driver: bridge
