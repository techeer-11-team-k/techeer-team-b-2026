# 매칭 로직 개선안 (DB 구조 분석 기반)

## DB 구조 분석 결과

### apartments.csv
- `apt_id`: 아파트 ID
- `region_id`: 지역 ID
- `apt_name`: 아파트 이름
- `kapt_code`: 아파트 코드

### apart_details.csv
- `apt_id`: 아파트 ID (apartments와 연결)
- `road_address`: 도로명 주소 (예: "서울특별시 종로구 율곡로 236")
- `jibun_address`: 지번 주소 (예: "서울특별시 종로구 충신동 60 힐스테이트 창경궁")
- `use_approval_date`: 사용승인일 (건축년도 추출 가능)

## 지번 주소 형식 분석

DB의 `jibun_address`는 다음과 같은 형식을 가집니다:

```
"시도 시군구 동 지번 아파트명"
```

**예시:**
- `"서울특별시 종로구 충신동 60 힐스테이트 창경궁"`
- `"대구광역시 수성구 황금동 99-1 황금동태왕아너스"`
- `"서울특별시 종로구 창신동 23-816 창신이수아파트"`
- `"대구광역시 수성구 지산동 1770- 더파크수성못"` (부번 없이 "-"만 있는 경우)

**특징:**
1. 동 이름 뒤에 지번(본번-부번)이 옴
2. 지번 뒤에 아파트명이 포함됨
3. 부번이 없는 경우도 있음 (예: "60", "667")
4. 부번이 없는데 "-"만 있는 경우도 있음 (예: "1770-")

## 현재 매칭 로직의 문제점

### 1. 지번 추출 패턴의 한계
현재 사용 중인 패턴: `r'(\d+)(?:-(\d+))?(?:\s|$)'`

**문제점:**
- 동 이름 뒤의 첫 번째 숫자를 찾지만, "1770-" 같은 경우 부번이 없어도 "-"가 있으면 추출이 불완전할 수 있음
- 지번 주소에 포함된 아파트명을 활용하지 않음
- 도로명 주소를 전혀 활용하지 않음

### 2. 지번 매칭 로직의 한계
- 지번 주소 전체를 정규화하여 포함 관계만 확인
- 동 이름과 지번의 위치 관계를 고려하지 않음
- 아파트명이 지번 주소에 포함되어 있음을 활용하지 않음

## 개선 방안

### 1. 지번 주소 파싱 강화

**개선된 파싱 로직:**
```python
def parse_jibun_address(jibun_address: str) -> Dict[str, Any]:
    """
    지번 주소를 파싱하여 구성 요소 추출
    
    입력: "서울특별시 종로구 충신동 60 힐스테이트 창경궁"
    출력: {
        'full_address': "서울특별시 종로구 충신동 60 힐스테이트 창경궁",
        'sido': "서울특별시",
        'sgg': "종로구",
        'dong': "충신동",
        'main_bunji': "60",
        'sub_bunji': None,
        'apt_name': "힐스테이트 창경궁",
        'jibun_only': "60"  # 본번-부번만
    }
    """
```

**구현 포인트:**
- 동 이름 뒤의 지번을 정확히 추출
- 아파트명 부분 분리
- 본번-부번 분리 (예: "99-1" → 본번="99", 부번="1")

### 2. 지번 주소에 포함된 아파트명 활용

**개선 방안:**
- 지번 주소에서 추출한 아파트명과 API 아파트명 비교
- 지번 주소의 아파트명이 API 아파트명과 유사하면 추가 점수 부여
- 지번 주소의 아파트명이 DB 아파트명과 일치하면 높은 신뢰도

**예시:**
- API: "힐스테이트 창경궁"
- DB 지번 주소: "서울특별시 종로구 충신동 60 힐스테이트 창경궁"
- → 지번 주소에 포함된 아파트명이 API와 일치하므로 높은 신뢰도

### 3. 도로명 주소 활용

**개선 방안:**
- 도로명 주소를 매칭 보조 수단으로 활용
- 도로명 주소가 일치하면 추가 점수 부여
- 지번 매칭이 불확실할 때 도로명 주소로 보완

**예시:**
- API 지번: "1101-1"
- DB 지번 주소: "서울시 영등포구 대림동 1101-1" (일치)
- DB 도로명 주소: "서울시 영등포구 대림로 123" (추가 검증)

### 4. 동 이름 추출 및 검증 강화

**개선 방안:**
- 지번 주소에서 동 이름을 정확히 추출
- API의 동 이름(umd_nm)과 DB 지번 주소의 동 이름 비교
- 동 이름이 일치하면 지번 매칭 신뢰도 향상

**예시:**
- API 동: "대림동"
- DB 지번 주소: "서울시 영등포구 대림동 1101-1"
- → 동 이름 일치로 지번 매칭 신뢰도 향상

### 5. 지번 추출 패턴 개선

**현재 패턴:**
```python
db_jibun_match = re.search(r'(\d+)(?:-(\d+))?(?:\s|$)', detail.jibun_address)
```

**개선된 패턴:**
```python
# 동 이름 뒤의 지번을 더 정확히 추출
# 패턴: "동이름 지번" 또는 "동이름 지번-부번"
dong_jibun_pattern = r'([가-힣]+(?:동|가|리|읍|면))\s+(\d+)(?:-(\d+))?(?:\s|$)'
match = re.search(dong_jibun_pattern, detail.jibun_address)
if match:
    dong_name = match.group(1)
    main_bunji = match.group(2)
    sub_bunji = match.group(3) if match.group(3) else None
```

## 구현 우선순위

### 높은 우선순위 (즉시 적용)
1. ✅ 지번 추출 패턴 개선 - 동 이름 뒤의 지번을 더 정확히 추출
2. ✅ 지번 주소에 포함된 아파트명 활용 - 추가 매칭 신호로 활용
3. ✅ 동 이름 추출 및 검증 강화 - 동 이름 일치 시 신뢰도 향상

### 중간 우선순위 (단기 개선)
4. 도로명 주소 활용 - 매칭 보조 수단으로 활용
5. 지번 주소 파싱 함수 추가 - 재사용 가능한 유틸리티 함수

### 낮은 우선순위 (장기 개선)
6. 지번 주소 정규화 - 다양한 형식 통일
7. 주소 데이터 품질 개선 - DB의 지번 주소 데이터 보완

## 예상 효과

1. **매칭 정확도 향상**
   - 지번 주소 파싱 정확도 향상으로 지번 기반 매칭 개선
   - 아파트명이 지번 주소에 포함된 경우 추가 검증 가능

2. **매칭 실패율 감소**
   - 도로명 주소 활용으로 지번 매칭 실패 시 보완
   - 동 이름 검증 강화로 미스매칭 방지

3. **데이터 품질 향상**
   - 지번 주소 구조 파악으로 데이터 검증 가능
   - 주소 데이터 불일치 발견 및 수정 가능
